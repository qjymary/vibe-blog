<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ vibe-blog - æŠ€æœ¯Vibeåšå®¢Agent</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Markdown æ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/sql.min.js"></script>
    <!-- Mermaid å›¾è¡¨æ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- å¯¼å‡ºå›¾ç‰‡ -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 50%, #eeeeee 100%);
            min-height: 100vh;
            color: #333;
        }
        .bg-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }
        .bg-animation::before {
            content: '';
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 20% 80%, rgba(255, 107, 53, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(78, 205, 196, 0.15) 0%, transparent 50%);
            animation: bgMove 20s ease-in-out infinite;
        }
        @keyframes bgMove {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-1%, 3%); }
        }
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 40px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .logo span {
            font-size: 24px; font-weight: 700;
            background: linear-gradient(135deg, #FF6B35, #FFD166);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .nav-links { display: flex; gap: 30px; }
        .nav-links a { color: rgba(0,0,0,0.6); text-decoration: none; font-size: 14px; }
        .nav-links a:hover { color: #000; }
        .nav-tabs { display: flex; gap: 10px; }
        .hero { text-align: center; padding: 50px 20px 30px; }
        .hero h1 {
            font-size: 42px; font-weight: 700; margin-bottom: 12px;
            background: linear-gradient(135deg, #FF6B35, #4ECDC4);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .hero p { font-size: 16px; color: rgba(0,0,0,0.6); }
        .main-card {
            max-width: 75vw; margin: 30px auto; padding: 24px;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab {
            padding: 10px 20px;
            background: rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            color: rgba(0,0,0,0.6);
            font-size: 14px; cursor: pointer;
        }
        .tab.active {
            background: linear-gradient(135deg, rgba(255,107,53,0.15), rgba(255,209,102,0.15));
            border-color: rgba(255,107,53,0.8);
            color: #FF6B35;
        }
        .input-wrapper {
            position: relative;
            background: rgba(255,255,255,0.95);
            border-radius: 14px;
            padding: 16px;
            border: none;
            z-index: 1;
        }
        .input-wrapper::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(90deg, 
                #3b82f6, #8b5cf6, #ec4899, #f97316, #eab308, #22c55e, #3b82f6);
            background-size: 400% 100%;
            border-radius: 16px;
            z-index: -1;
            animation: borderGlow 6s linear infinite;
            filter: blur(4px);
            opacity: 0.7;
        }
        .input-wrapper::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            border-radius: 14px;
            z-index: -1;
        }
        @keyframes borderGlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 400% 50%; }
        }
        .input-wrapper:focus-within::before {
            opacity: 1;
            filter: blur(6px);
        }
        .text-input {
            width: 100%; background: transparent; border: none;
            color: #333; font-size: 15px; resize: none;
            min-height: 80px; outline: none; font-family: inherit;
        }
        .text-input::placeholder { color: rgba(0,0,0,0.3); }
        .options-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 16px; padding-top: 16px;
            border-top: 1px solid rgba(0,0,0,0.05);
            flex-wrap: wrap; gap: 12px;
        }
        .option-tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .option-tag {
            padding: 8px 14px;
            background: rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 18px;
            font-size: 13px; color: rgba(0,0,0,0.7);
            cursor: pointer;
        }
        .option-tag.active {
            background: rgba(78,205,196,0.2);
            border-color: rgba(78,205,196,0.5);
            color: #4ECDC4;
        }
        .create-btn {
            padding: 12px 28px;
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            border: none; border-radius: 10px;
            color: #fff; font-size: 15px; font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(78,205,196,0.3);
        }
        .create-btn:hover { transform: translateY(-2px); }
        .create-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* è¿›åº¦é¢æ¿ */
        .progress-panel {
            display: none;
            max-width: 75vw;
            margin: 30px auto;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(245,245,245,0.95));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .progress-panel.show { display: block; }
        .progress-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px;
            background: rgba(0,0,0,0.02);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .progress-title {
            font-size: 16px; font-weight: 600;
            color: #4ECDC4;
            display: flex; align-items: center; gap: 8px;
        }
        .close-btn {
            width: 32px; height: 32px;
            background: rgba(0,0,0,0.05);
            border: none; border-radius: 8px;
            color: #333; font-size: 18px;
            cursor: pointer;
        }
        .export-progress-btn {
            width: 32px; height: 32px;
            background: rgba(78,205,196,0.1);
            border: 1px solid rgba(78,205,196,0.3);
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .export-progress-btn:hover {
            background: rgba(78,205,196,0.2);
            border-color: rgba(78,205,196,0.5);
        }
        .progress-body {
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
        }
        .progress-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.5), rgba(245,245,245,0.5));
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 10px;
            border-left: 3px solid #4ECDC4;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .progress-item .time {
            font-size: 11px; color: #999; margin-bottom: 4px;
        }
        .progress-item .message {
            font-size: 14px; color: #333;
        }
        .progress-item .detail {
            font-size: 13px; color: #666;
            margin-top: 8px; padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
        }
        .progress-item.success { border-left-color: #4ECDC4; }
        .progress-item.error { border-left-color: #ff6b6b; }
        .progress-item.stream { border-left-color: #FFD166; }
        .progress-footer {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 20px;
            background: rgba(0,0,0,0.02);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .progress-status {
            display: flex; align-items: center; gap: 10px;
        }
        .status-badge {
            padding: 6px 14px;
            background: rgba(78,205,196,0.2);
            border-radius: 20px;
            font-size: 13px; color: #4ECDC4;
        }
        .stop-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            border: none; border-radius: 8px;
            color: #fff; font-size: 13px;
            cursor: pointer;
        }
        .dots {
            display: inline-block;
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .dots::after { content: '...'; animation: dots 1.5s infinite; }

        /* ç»“æœåŒºåŸŸ */
        .result-section {
            display: none;
            max-width: 75vw;
            margin: 30px auto;
            padding: 0;
        }
        .result-section.show { display: block; }
        .result-card {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(0,0,0,0.1);
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .result-header {
            padding: 20px 24px;
            background: rgba(0,0,0,0.02);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .result-title { font-size: 20px; font-weight: 600; color: #333; }
        .result-meta { 
            display: flex; 
            gap: 8px; 
            margin-top: 8px; 
            flex-wrap: wrap;
        }
        .meta-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .meta-tag.sections { background: rgba(78,205,196,0.15); color: #2a9d8f; }
        .meta-tag.code { background: rgba(255,107,53,0.15); color: #e85d04; }
        .meta-tag.images { background: rgba(138,43,226,0.15); color: #7b2cbf; }
        .meta-tag.score { background: rgba(34,197,94,0.15); color: #16a34a; }
        .result-pages { padding: 20px; }
        .page-item {
            background: rgba(0,0,0,0.02);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .page-header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
        .page-number {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #FF6B35, #FFD166);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 14px; color: #fff;
        }
        .page-title { font-size: 16px; font-weight: 600; color: #333; }
        .page-content { color: rgba(0,0,0,0.7); line-height: 1.8; margin-bottom: 14px; font-size: 14px; }
        .page-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .page-tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        .page-tag.metaphor { background: rgba(78,205,196,0.1); border: 1px solid rgba(78,205,196,0.3); color: #4ECDC4; }
        .page-tag.tech { background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.3); color: #FF6B35; }
        .page-tag.example { background: rgba(255,209,102,0.1); border: 1px solid rgba(255,209,102,0.3); color: #FFD166; }
        .page-takeaway {
            padding: 10px 14px;
            background: rgba(78,205,196,0.1);
            border-left: 3px solid #4ECDC4;
            border-radius: 0 8px 8px 0;
            font-size: 13px; color: rgba(0,0,0,0.7);
            margin-bottom: 12px;
        }
        .page-image { margin-top: 14px; border-radius: 12px; overflow: hidden; }
        .page-image img { width: 100%; height: auto; }

        /* Markdown æ¸²æŸ“æ ·å¼ */
        .markdown-body {
            color: rgba(0,0,0,0.8);
            line-height: 1.8;
            font-size: 15px;
            max-height: 700px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4 {
            color: #333;
            margin: 24px 0 12px 0;
            font-weight: 600;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 8px;
        }
        .markdown-body h1 { font-size: 28px; }
        .markdown-body h2 { font-size: 22px; }
        .markdown-body h3 { font-size: 18px; }
        .markdown-body h4 { font-size: 16px; }
        .markdown-body p { margin: 12px 0; }
        .markdown-body ul, .markdown-body ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        .markdown-body li { margin: 6px 0; }
        .markdown-body blockquote {
            margin: 16px 0;
            padding: 12px 20px;
            background: rgba(78,205,196,0.1);
            border-left: 4px solid #4ECDC4;
            border-radius: 0 8px 8px 0;
            color: rgba(0,0,0,0.7);
        }
        .markdown-body code {
            background: rgba(0,0,0,0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Fira Code', 'Monaco', monospace;
            font-size: 13px;
            color: #FF6B35;
        }
        .markdown-body pre {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .markdown-body pre code {
            background: transparent;
            padding: 0;
            font-size: 13px;
            line-height: 1.6;
        }
        .markdown-body a {
            color: #4ECDC4;
            text-decoration: none;
        }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body img {
            max-width: 100%;
            border-radius: 10px;
            margin: 16px 0;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid rgba(0,0,0,0.1);
            padding: 10px 14px;
            text-align: left;
        }
        .markdown-body th {
            background: rgba(0,0,0,0.05);
            font-weight: 600;
        }
        .markdown-body hr {
            border: none;
            border-top: 1px solid rgba(0,0,0,0.1);
            margin: 24px 0;
        }
        .markdown-body .mermaid {
            background: rgba(0,0,0,0.02);
            border-radius: 10px;
            padding: 20px;
            margin: 16px 0;
            text-align: center;
        }
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .markdown-body::-webkit-scrollbar { width: 6px; }
        .markdown-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 3px; }
        .markdown-body::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
        .markdown-body::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

        /* ç¤ºä¾‹å¡ç‰‡ */
        .examples-section { max-width: 75vw; margin: 40px auto; padding: 0 20px; }
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #333; }
        .examples-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .example-card {
            background: rgba(255,255,255,0.8);
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .example-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255,107,53,0.5);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        .example-image {
            height: 140px;
            background: linear-gradient(135deg, #f5f5f5, #eeeeee);
            display: flex; align-items: center; justify-content: center;
            font-size: 40px;
        }
        .example-content { padding: 16px; }
        .example-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; color: #333; }
        .example-desc { font-size: 12px; color: rgba(0,0,0,0.5); }

        /* å†å²è®°å½•åŒºåŸŸ */
        .history-section { max-width: 75vw; margin: 40px auto; padding: 0 20px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .history-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .history-card {
            background: rgba(255,255,255,0.8);
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative;
        }
        .history-card:hover {
            transform: translateY(-4px);
            border-color: rgba(78,205,196,0.5);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        /* æš‚æ—¶éšè—åˆ é™¤æŒ‰é’®ï¼Œåç»­éœ€è¦æ—¶å–æ¶ˆæ³¨é‡Š display: none */
        .history-card .delete-btn {
            display: none;
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255,107,107,0.9);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .history-card:hover .delete-btn { opacity: 1; }
        .history-card .delete-btn:hover { background: #ff6b6b; }
        .history-cover {
            height: 120px;
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            display: flex; align-items: center; justify-content: center;
            font-size: 36px;
            overflow: hidden;
        }
        .history-cover img { width: 100%; height: 100%; object-fit: cover; }
        .history-content { padding: 14px; }
        .history-topic { font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #333; 
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .history-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .history-meta span {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0,0,0,0.05);
            color: rgba(0,0,0,0.6);
        }
        .history-time { font-size: 11px; color: rgba(0,0,0,0.4); }
        .history-empty {
            text-align: center;
            padding: 40px;
            color: rgba(0,0,0,0.4);
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .navbar { padding: 15px 20px; }
            .nav-links { display: none; }
            .hero h1 { font-size: 28px; }
            .main-card { margin: 20px; padding: 18px; }
            .options-bar { flex-direction: column; }
            .create-btn { width: 100%; }
        }
        
        /* æ–‡æ¡£è§£æä¸­è½¬åœˆåŠ¨ç”» */
        .doc-status.spinning {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* è¿›åº¦æ¡è„‰å†²åŠ¨ç”» */
        @keyframes progress-pulse {
            0%, 100% { width: 20%; margin-left: 0; }
            50% { width: 60%; margin-left: 20%; }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <nav class="navbar">
        <div class="logo"><span>vibe-blog</span></div>
        <div class="nav-tabs">
            <div class="tab active">ğŸ“ é•¿æ–‡åšå®¢</div>
            <a href="/reviewer" class="tab" id="reviewerTab" style="text-decoration: none; display: none;">ğŸ” æ•™ç¨‹è¯„ä¼°</a>
        </div>
    </nav>

    <section class="hero">
        <h1>è®©æŠ€æœ¯å˜å¾—äººäººéƒ½èƒ½æ‡‚</h1>
        <p>åŸºäºMulti-Agent æ¶æ„çš„ AI é•¿æ–‡åšå®¢ç”Ÿæˆå™¨<br>æ·±åº¦è°ƒç ” Â· æ™ºèƒ½é…å›¾ Â· ä¸€é”®ç”Ÿæˆ</p>
    </section>

    <div class="main-card">
        <!-- å·²ä¸Šä¼ æ–‡æ¡£åˆ—è¡¨ï¼ˆè¾“å…¥æ¡†ä¸Šæ–¹ï¼‰ -->
        <div id="uploadedDocsList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;"></div>
        <div class="input-wrapper" style="position: relative;">
            <textarea class="text-input" id="contentInput" placeholder="è¾“å…¥æŠ€æœ¯ä¸»é¢˜ï¼Œå¦‚ï¼šLangGraph å…¥é—¨æ•™ç¨‹ã€Redis æ€§èƒ½ä¼˜åŒ–..." style="padding-bottom: 50px;"></textarea>
            <!-- è¾“å…¥æ¡†åº•éƒ¨å·¥å…·æ  -->
            <div style="position: absolute; bottom: 12px; left: 16px; right: 16px; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <!-- ä¸Šä¼ æ–‡ä»¶å›¾æ ‡ -->
                    <div style="position: relative; display: inline-block;">
                        <label id="uploadBtnLabel" style="
                            display: flex; align-items: center; justify-content: center;
                            width: 32px; height: 32px; border-radius: 8px;
                            border: 1px solid #e0e0e0; background: #fff;
                            cursor: pointer; transition: all 0.2s;
                        " title="ä¸Šä¼ çŸ¥è¯†æ–‡æ¡£">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                            </svg>
                            <input type="file" id="knowledgeFileInput" accept=".pdf,.md,.txt,.markdown" style="display: none;" multiple>
                        </label>
                        <div class="upload-tooltip" style="
                            display: none; position: absolute; left: 0; bottom: 100%; margin-bottom: 8px;
                            background: #1a1a1a; color: #fff; padding: 10px 14px;
                            border-radius: 8px; font-size: 12px; line-height: 1.6;
                            white-space: nowrap; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        ">
                            PDF æ–‡ä»¶ä¸è¶…è¿‡ 15 é¡µ<br>
                            æ”¯æŒ PDFã€Markdownã€TXT æ ¼å¼
                            <div style="position: absolute; bottom: -6px; left: 12px; width: 0; height: 0; 
                                border-left: 6px solid transparent; border-right: 6px solid transparent; 
                                border-top: 6px solid #1a1a1a;"></div>
                        </div>
                    </div>
                    <!-- æ–‡ç« ç±»å‹é€‰é¡¹ -->
                    <div style="display: flex; align-items: center; gap: 6px;" id="articleTypeOptions">
                        <div class="option-tag active" data-article-type="tutorial" style="padding: 4px 10px; font-size: 11px; border-radius: 12px;">ğŸ“š æ•™ç¨‹å‹</div>
                        <div class="option-tag" data-article-type="problem-solution" style="padding: 4px 10px; font-size: 11px; border-radius: 12px;">ğŸ”§ é—®é¢˜è§£å†³</div>
                        <div class="option-tag" data-article-type="comparison" style="padding: 4px 10px; font-size: 11px; border-radius: 12px;">âš–ï¸ å¯¹æ¯”åˆ†æ</div>
                        <div class="option-tag" data-article-type="storybook" style="padding: 4px 10px; font-size: 11px; border-radius: 12px;">ğŸ¨ ç§‘æ™®ç»˜æœ¬</div>
                        <div class="option-tag active" data-length="short" style="padding: 4px 10px; font-size: 11px; border-radius: 12px;">ğŸ“„ çŸ­æ–‡</div>
                        <div class="option-tag" data-length="medium" style="padding: 4px 10px; font-size: 11px; border-radius: 12px;">ğŸ“‘ ä¸­ç­‰</div>
                        <div class="option-tag" data-length="long" style="padding: 4px 10px; font-size: 11px; border-radius: 12px;">ğŸ“– é•¿æ–‡</div>
                                            </div>
                </div>
                <!-- ç”ŸæˆæŒ‰é’® -->
                <button id="createBlogBtn" style="
                    width: 36px; height: 36px; border-radius: 50%;
                    background: linear-gradient(135deg, #4ECDC4, #44a08d);
                    border: none; cursor: pointer;
                    display: flex; align-items: center; justify-content: center;
                    transition: all 0.2s; box-shadow: 0 2px 8px rgba(78,205,196,0.3);
                    flex-shrink: 0;
                " title="ç”Ÿæˆåšå®¢">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- é«˜çº§é€‰é¡¹æŒ‰é’®ï¼ˆè¾“å…¥æ¡†ä¸‹æ–¹ï¼‰ -->
        <div style="margin-top: 12px;">
            <div class="option-tag" id="advancedOptionsBtn" style="
                padding: 6px 14px; 
                font-size: 12px; 
                border-radius: 16px; 
                display: inline-flex;
                align-items: center;
                gap: 4px;
                cursor: pointer;
            ">âš™ï¸ é«˜çº§é€‰é¡¹ <span style="font-size: 10px;">â–¼</span></div>
        </div>
        
        <!-- é«˜çº§é€‰é¡¹é¢æ¿ï¼ˆå¯æŠ˜å ï¼‰ -->
        <div id="advancedOptionsPanel" style="
            display: none;
            margin-top: 8px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.08);
        ">
            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 13px; color: #666;">ğŸ¨ é…å›¾é£æ ¼:</span>
                    <select id="imageStyleSelect" style="
                        padding: 6px 12px;
                        border: 1px solid rgba(0,0,0,0.15);
                        border-radius: 8px;
                        font-size: 13px;
                        background: #fff;
                        cursor: pointer;
                        outline: none;
                        min-width: 160px;
                    ">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- åšå®¢ç”Ÿæˆå†…å®¹åŒº -->
        <div id="blogContent"></div>
        
        <!-- æ•™ç¨‹è¯„ä¼°å†…å®¹åŒº (vibe-reviewer) -->
        <div id="reviewerContent" style="display: none;">
            <div class="input-wrapper" style="margin-bottom: 16px;">
                <input type="text" class="text-input" id="gitUrlInput" 
                    placeholder="è¾“å…¥ Git ä»“åº“ URLï¼Œå¦‚ï¼šhttps://github.com/user/tutorial.git"
                    style="width: 100%; padding: 16px; border: none; background: transparent; font-size: 16px; outline: none;">
            </div>
            <div class="options-bar" id="reviewerOptions">
                <div class="option-tags">
                    <div class="option-tag active" data-search="true">ğŸ” å¯ç”¨æœç´¢å¢å¼º</div>
                    <div class="option-tag" data-search="false">âš¡ å¿«é€Ÿè¯„ä¼°</div>
                </div>
                <button class="create-btn" id="startReviewBtn" style="background: linear-gradient(135deg, #4ECDC4, #45B7AA);">ğŸš€ å¼€å§‹è¯„ä¼°</button>
            </div>
            
            <!-- æ•™ç¨‹åˆ—è¡¨ -->
            <div id="tutorialList" style="margin-top: 20px;">
                <div style="font-size: 14px; color: #666; margin-bottom: 12px;">ğŸ“š å·²æ·»åŠ çš„æ•™ç¨‹</div>
                <div id="tutorialCards" style="display: grid; gap: 12px;"></div>
            </div>
        </div>
    </div>

    <!-- è¿›åº¦é¢æ¿ -->
    <div class="progress-panel" id="progressPanel">
        <div class="progress-header">
            <div class="progress-title">âœ¨ AI å·¥ä½œçŠ¶æ€</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="export-progress-btn" id="exportProgressBtn" title="å¯¼å‡ºä¸ºå›¾ç‰‡">ğŸ“·</button>
                <button class="close-btn" id="closeProgress">Ã—</button>
            </div>
        </div>
        <div class="progress-body" id="progressBody"></div>
        <div class="progress-footer">
            <div class="progress-status">
                <div class="status-badge" id="statusBadge">å‡†å¤‡ä¸­</div>
                <span id="progressText">ç­‰å¾…å¼€å§‹</span>
            </div>
            <button class="stop-btn" id="stopBtn">â–  åœæ­¢</button>
        </div>
    </div>

    <!-- ç»“æœåŒºåŸŸ -->
    <section class="result-section" id="resultSection">
        <div class="result-card">
            <div class="result-header">
                <div class="result-title" id="resultTitle">ç”Ÿæˆç»“æœ</div>
                <div class="result-meta" id="resultMeta"></div>
            </div>
            <div class="result-pages" id="resultPages"></div>
        </div>
    </section>

    <!-- ç¤ºä¾‹åŒºåŸŸ -->
    <section class="examples-section" id="examples">
        <h2 class="section-title">ğŸ”¥ çƒ­é—¨ç¤ºä¾‹</h2>
        <div class="examples-grid">
            <div class="example-card" data-content="Redis æ˜¯ä¸€ä¸ªå¼€æºçš„ã€åŸºäºå†…å­˜çš„æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ã€‚å®ƒæ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œå¦‚å­—ç¬¦ä¸²ã€å“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆç­‰ã€‚Redis çš„æœ€å¤§ç‰¹ç‚¹æ˜¯é€Ÿåº¦å¿«ï¼Œå› ä¸ºæ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™é€Ÿåº¦å¯ä»¥è¾¾åˆ°æ¯ç§’ 10 ä¸‡æ¬¡ä»¥ä¸Šã€‚">
                <div class="example-image">ğŸª</div>
                <div class="example-content">
                    <div class="example-title">Redis å…¥é—¨</div>
                    <div class="example-desc">ç”¨ä¾¿åˆ©åº—çš„æ¯”å–»ï¼Œè®©ä½ ç§’æ‡‚ Redis ç¼“å­˜åŸç†</div>
                </div>
            </div>
            <div class="example-card" data-content="æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ç§åº”ç”¨ç¨‹åºé—´çš„é€šä¿¡æ–¹æ³•ï¼Œå…è®¸åº”ç”¨ç¨‹åºé€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯æ¥è¿›è¡Œå¼‚æ­¥é€šä¿¡ã€‚ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸»è¦ä¼˜ç‚¹åŒ…æ‹¬ï¼šè§£è€¦ã€å¼‚æ­¥å¤„ç†ã€å‰Šå³°å¡«è°·ã€å¯é æ€§ä¿è¯ç­‰ã€‚">
                <div class="example-image">ğŸ“¦</div>
                <div class="example-content">
                    <div class="example-title">æ¶ˆæ¯é˜Ÿåˆ—åŸç†</div>
                    <div class="example-desc">å¿«é€’é©¿ç«™çš„æ•…äº‹ï¼Œç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„å¼‚æ­¥é­”æ³•</div>
                </div>
            </div>
            <div class="example-card" data-content="åˆ†å¸ƒå¼é”æ˜¯æ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´åŒæ­¥è®¿é—®å…±äº«èµ„æºçš„ä¸€ç§æ–¹å¼ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªè¿›ç¨‹å¯èƒ½åŒæ—¶è®¿é—®åŒä¸€ä¸ªèµ„æºï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥åè°ƒã€‚">
                <div class="example-image">ğŸ”’</div>
                <div class="example-content">
                    <div class="example-title">åˆ†å¸ƒå¼é”è¯¦è§£</div>
                    <div class="example-desc">å…¬å…±å•æ‰€çš„é”ï¼Œç§’æ‡‚åˆ†å¸ƒå¼é”çš„ç²¾é«“</div>
                </div>
            </div>
        </div>
    </section>

    <!-- å†å²è®°å½•åŒºåŸŸ -->
    <section class="history-section" id="historySection">
        <div class="history-header">
            <h2 class="section-title">ğŸ“œ å†å²è®°å½•</h2>
        </div>
        <div class="history-grid" id="historyGrid">
            <div class="history-empty">æš‚æ— å†å²è®°å½•ï¼Œç”Ÿæˆåšå®¢åå°†è‡ªåŠ¨ä¿å­˜</div>
        </div>
    </section>

    <script>
        let selectedPages = 5;
        let generateImages = false;
        let currentTab = 'transform';
        let currentTaskId = null;
        let eventSource = null;
        
        // é•¿æ–‡åšå®¢é€‰é¡¹
        let articleType = 'tutorial';
        let targetLength = 'short';
        
        // å·²ä¸Šä¼ çš„çŸ¥è¯†æ–‡æ¡£
        let uploadedDocuments = [];
        
        // ========== åŠ è½½å‰ç«¯é…ç½® ==========
        (async function loadFrontendConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                if (data.success && data.config) {
                    // æ ¹æ®é…ç½®æ˜¾ç¤º/éšè— reviewer å…¥å£
                    if (data.config.reviewer_enabled) {
                        const reviewerTab = document.getElementById('reviewerTab');
                        if (reviewerTab) reviewerTab.style.display = 'block';
                    }
                }
            } catch (e) {
                console.warn('åŠ è½½å‰ç«¯é…ç½®å¤±è´¥:', e);
            }
        })();
        
        // ========== çŸ¥è¯†æ–‡æ¡£ä¸Šä¼ åŠŸèƒ½ ==========
        
        // ä¸Šä¼ æŒ‰é’®æ‚¬æµ®æç¤º
        const uploadBtnLabel = document.getElementById('uploadBtnLabel');
        const uploadTooltip = uploadBtnLabel.parentElement.querySelector('.upload-tooltip');
        uploadBtnLabel.addEventListener('mouseenter', () => {
            uploadTooltip.style.display = 'block';
        });
        uploadBtnLabel.addEventListener('mouseleave', () => {
            uploadTooltip.style.display = 'none';
        });
        
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('knowledgeFileInput').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files.length) return;
            
            for (const file of files) {
                await uploadDocument(file);
            }
            e.target.value = ''; // æ¸…ç©º input ä»¥ä¾¿é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
        });
        
        // ä¸Šä¼ å•ä¸ªæ–‡æ¡£
        async function uploadDocument(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            const tempId = 'temp_' + Date.now();
            addDocumentTag(tempId, file.name, 'uploading', file.size);
            
            try {
                const response = await fetch('/api/blog/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // ç§»é™¤ä¸´æ—¶æ ‡ç­¾
                removeDocumentTag(tempId);
                
                if (data.success) {
                    uploadedDocuments.push({
                        id: data.document_id,
                        filename: data.filename,
                        status: data.status,
                        fileSize: file.size
                    });
                    addDocumentTag(data.document_id, data.filename, 'pending', file.size);
                    // å¼€å§‹è½®è¯¢è§£æçŠ¶æ€
                    pollDocumentStatus(data.document_id);
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                removeDocumentTag(tempId);
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        }
        
        // è½®è¯¢æ–‡æ¡£è§£æçŠ¶æ€
        async function pollDocumentStatus(docId) {
            const maxAttempts = 60; // æœ€å¤šè½®è¯¢ 60 æ¬¡ï¼ˆçº¦ 2 åˆ†é’Ÿï¼‰
            let attempts = 0;
            
            const poll = async () => {
                if (attempts >= maxAttempts) {
                    updateDocumentTagStatus(docId, 'timeout');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/blog/upload/${docId}/status`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const status = data.status;
                        const wordCount = data.markdown_length || 0;
                        const errorMessage = data.error_message || '';
                        
                        // æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆåŒ…æ‹¬é”™è¯¯ä¿¡æ¯ï¼‰
                        const doc = uploadedDocuments.find(d => d.id === docId);
                        if (doc) {
                            doc.status = status;
                            doc.wordCount = wordCount;
                            doc.errorMessage = errorMessage;
                        }
                        
                        updateDocumentTagStatus(docId, status, wordCount);
                        
                        if (status === 'ready' || status === 'error') {
                            return;
                        }
                    }
                } catch (e) {
                    console.error('è½®è¯¢æ–‡æ¡£çŠ¶æ€å¤±è´¥:', e);
                }
                
                attempts++;
                setTimeout(poll, 2000); // æ¯ 2 ç§’è½®è¯¢ä¸€æ¬¡
            };
            
            poll();
        }
        
        // æ·»åŠ æ–‡æ¡£æ ‡ç­¾åˆ° UI
        function addDocumentTag(docId, filename, status, fileSize = 0, wordCount = 0) {
            const container = document.getElementById('uploadedDocsList');
            const tag = document.createElement('div');
            tag.id = `doc-tag-${docId}`;
            tag.className = 'doc-tag';
            tag.style.cssText = `
                display: flex; flex-direction: column; gap: 6px;
                padding: 12px 16px; background: #fff;
                border: 1px solid #e5e7eb; border-radius: 12px;
                font-size: 13px; color: #333; min-width: 200px; max-width: 280px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            `;
            
            const shortName = filename.length > 20 ? filename.substring(0, 18) + '...' : filename;
            const fileSizeStr = fileSize > 0 ? formatFileSize(fileSize) : '';
            const fileExt = filename.split('.').pop().toUpperCase();
            const statusText = getStatusText(status);
            const isLoading = isSpinningStatus(status);
            
            // PDF å›¾æ ‡ SVG
            const pdfIcon = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="4" y="2" width="16" height="20" rx="2" fill="#FEE2E2" stroke="#EF4444" stroke-width="1.5"/>
                <path d="M8 7h8M8 11h8M8 15h5" stroke="#EF4444" stroke-width="1.5" stroke-linecap="round"/>
                <rect x="12" y="14" width="6" height="6" rx="1" fill="#EF4444"/>
                <text x="15" y="18.5" font-size="4" fill="white" text-anchor="middle" font-weight="bold">PDF</text>
            </svg>`;
            
            tag.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="flex-shrink: 0;">${pdfIcon}</div>
                    <span class="doc-name" title="${filename}" style="flex: 1; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px;">${shortName}</span>
                    <button onclick="removeDocument('${docId}')" style="
                        background: none; border: none; color: #9ca3af;
                        cursor: pointer; font-size: 18px; padding: 0; line-height: 1;
                    ">Ã—</button>
                </div>
                <div class="doc-progress-row" style="display: flex; align-items: center; gap: 6px; font-size: 12px; padding-left: 38px;">
                    ${isLoading ? `
                        <span style="color: #f97316;">${statusText}</span>
                        ${fileSizeStr ? `<span style="color: #9ca3af;">Â· ${fileSizeStr}</span>` : ''}
                    ` : `
                        <span style="color: #6b7280;">${fileExt}</span>
                        ${fileSizeStr ? `<span style="color: #9ca3af;">Â· ${fileSizeStr}</span>` : ''}
                        <span class="doc-word-count" style="color: #9ca3af;"></span>
                    `}
                </div>
            `;
            container.appendChild(tag);
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
            return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const texts = {
                'uploading': 'ä¸Šä¼ ä¸­...',
                'pending': 'ç­‰å¾…è§£æ...',
                'parsing': 'è§£æä¸­...',
                'ready': 'å·²å°±ç»ª',
                'error': 'è§£æå¤±è´¥',
                'timeout': 'è¶…æ—¶'
            };
            return texts[status] || status;
        }
        
        // è·å–çŠ¶æ€å›¾æ ‡
        function getStatusIcon(status) {
            const icons = {
                'uploading': 'â³',
                'pending': 'ğŸ”„',
                'parsing': 'âš™ï¸',
                'ready': 'âœ…',
                'error': 'âŒ',
                'timeout': 'âš ï¸'
            };
            return icons[status] || 'ğŸ“„';
        }
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬åœˆåŠ¨ç”»
        function isSpinningStatus(status) {
            return ['uploading', 'pending', 'parsing'].includes(status);
        }
        
        // æ›´æ–°æ–‡æ¡£æ ‡ç­¾çŠ¶æ€ï¼ˆè±†åŒ…é£æ ¼ï¼‰
        function updateDocumentTagStatus(docId, status, wordCount = 0) {
            const tag = document.getElementById(`doc-tag-${docId}`);
            if (!tag) return;
            
            const progressRow = tag.querySelector('.doc-progress-row');
            const doc = uploadedDocuments.find(d => d.id === docId);
            const fileSizeStr = doc && doc.fileSize ? formatFileSize(doc.fileSize) : '';
            const fileExt = doc && doc.filename ? doc.filename.split('.').pop().toUpperCase() : 'PDF';
            const statusText = getStatusText(status);
            const isLoading = isSpinningStatus(status);
            const wordCountStr = wordCount > 0 ? formatWordCount(wordCount) : (doc && doc.wordCount ? formatWordCount(doc.wordCount) : '');
            
            // ä¿å­˜å­—æ•°åˆ°æ–‡æ¡£å¯¹è±¡
            if (wordCount > 0 && doc) {
                doc.wordCount = wordCount;
            }
            
            if (progressRow) {
                if (isLoading) {
                    progressRow.innerHTML = `
                        <span style="color: #f97316;">${statusText}</span>
                        ${fileSizeStr ? `<span style="color: #9ca3af;">Â· ${fileSizeStr}</span>` : ''}
                    `;
                } else if (status === 'ready') {
                    progressRow.innerHTML = `
                        <span style="color: #6b7280;">${fileExt}</span>
                        ${fileSizeStr ? `<span style="color: #9ca3af;">Â· ${fileSizeStr}</span>` : ''}
                        ${wordCountStr ? `<span style="color: #9ca3af;">Â· ${wordCountStr}</span>` : ''}
                    `;
                } else if (status === 'error') {
                    const errorMsg = doc && doc.errorMessage ? doc.errorMessage : 'è§£æå¤±è´¥';
                    progressRow.innerHTML = `
                        <span style="color: #ef4444;" title="${errorMsg}">${errorMsg.length > 20 ? errorMsg.substring(0, 18) + '...' : errorMsg}</span>
                    `;
                }
            }
            
            // æ ¹æ®çŠ¶æ€æ›´æ–°è¾¹æ¡†æ ·å¼
            if (status === 'ready') {
                tag.style.borderColor = '#e5e7eb';
                tag.style.background = '#fff';
            } else if (status === 'error') {
                tag.style.borderColor = '#fecaca';
                tag.style.background = '#fef2f2';
            }
        }
        
        // æ ¼å¼åŒ–å­—æ•°
        function formatWordCount(count) {
            if (count >= 10000) {
                return `çº¦ ${(count / 10000).toFixed(1)} ä¸‡å­—`;
            } else if (count >= 1000) {
                return `çº¦ ${(count / 1000).toFixed(1)} åƒå­—`;
            }
            return `${count} å­—`;
        }
        
        // ç§»é™¤æ–‡æ¡£æ ‡ç­¾
        function removeDocumentTag(docId) {
            const tag = document.getElementById(`doc-tag-${docId}`);
            if (tag) tag.remove();
        }
        
        // ç§»é™¤æ–‡æ¡£
        async function removeDocument(docId) {
            // ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤
            uploadedDocuments = uploadedDocuments.filter(d => d.id !== docId);
            removeDocumentTag(docId);
            
            // å¯é€‰ï¼šè°ƒç”¨åç«¯åˆ é™¤ APIï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            // await fetch(`/api/blog/documents/${docId}`, { method: 'DELETE' });
        }
        
        // è·å–å·²å°±ç»ªçš„æ–‡æ¡£ ID åˆ—è¡¨
        function getReadyDocumentIds() {
            return uploadedDocuments
                .filter(d => d.status === 'ready')
                .map(d => d.id);
        }

        // Tab åˆ‡æ¢
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;
                
                // åˆ‡æ¢é€‰é¡¹æ å’Œå ä½ç¬¦
                const transformOptions = document.getElementById('transformOptions');
                const articleTypeOptions = document.getElementById('articleTypeOptions');
                
                // è·å–å†…å®¹åŒºåŸŸ
                const blogContent = document.getElementById('blogContent');
                const reviewerContent = document.getElementById('reviewerContent');
                const contentInput = document.getElementById('contentInput');
                
                // éšè—ç¤ºä¾‹å’Œå†å²åŒºåŸŸ (reviewer æ¨¡å¼ä¸‹)
                const examplesSection = document.getElementById('examples');
                const historySection = document.getElementById('historySection');
                
                if (currentTab === 'transform') {
                    if (transformOptions) transformOptions.style.display = 'flex';
                    if (articleTypeOptions) articleTypeOptions.style.display = 'none';
                    if (blogContent) blogContent.style.display = 'block';
                    if (reviewerContent) reviewerContent.style.display = 'none';
                    if (contentInput) contentInput.parentElement.style.display = 'block';
                    if (contentInput) contentInput.placeholder = 'ç²˜è´´æŠ€æœ¯åšå®¢å†…å®¹ï¼ŒAI å°†è½¬åŒ–ä¸ºé€šä¿—æ˜“æ‡‚çš„ç§‘æ™®ç»˜æœ¬...';
                    if (examplesSection) examplesSection.style.display = 'block';
                    if (historySection) historySection.style.display = 'block';
                } else if (currentTab === 'blog') {
                    if (transformOptions) transformOptions.style.display = 'none';
                    if (articleTypeOptions) articleTypeOptions.style.display = 'flex';
                    if (blogContent) blogContent.style.display = 'block';
                    if (reviewerContent) reviewerContent.style.display = 'none';
                    if (contentInput) contentInput.parentElement.style.display = 'block';
                    if (contentInput) contentInput.placeholder = 'è¾“å…¥æŠ€æœ¯ä¸»é¢˜ï¼Œå¦‚ï¼šLangGraph å…¥é—¨æ•™ç¨‹ã€Redis æ€§èƒ½ä¼˜åŒ–...';
                    if (examplesSection) examplesSection.style.display = 'block';
                    if (historySection) historySection.style.display = 'block';
                } else if (currentTab === 'reviewer') {
                    if (transformOptions) transformOptions.style.display = 'none';
                    if (articleTypeOptions) articleTypeOptions.style.display = 'none';
                    if (blogContent) blogContent.style.display = 'none';
                    if (reviewerContent) reviewerContent.style.display = 'block';
                    if (contentInput) contentInput.parentElement.style.display = 'none';
                    // éšè—ç¤ºä¾‹å’Œå†å²åŒºåŸŸ
                    if (examplesSection) examplesSection.style.display = 'none';
                    if (historySection) historySection.style.display = 'none';
                    // åŠ è½½æ•™ç¨‹åˆ—è¡¨
                    loadTutorials();
                } else {
                    if (transformOptions) transformOptions.style.display = 'flex';
                    if (articleTypeOptions) articleTypeOptions.style.display = 'none';
                    if (blogContent) blogContent.style.display = 'block';
                    if (reviewerContent) reviewerContent.style.display = 'none';
                    if (contentInput) contentInput.parentElement.style.display = 'block';
                    if (contentInput) contentInput.placeholder = 'æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å›¾ç‰‡...';
                    if (examplesSection) examplesSection.style.display = 'block';
                    if (historySection) historySection.style.display = 'block';
                }
            });
        });

        // é€‰é¡¹åˆ‡æ¢
        document.querySelectorAll('.option-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                if (tag.dataset.pages) {
                    document.querySelectorAll('.option-tag[data-pages]').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                    selectedPages = parseInt(tag.dataset.pages);
                } else if (tag.dataset.images) {
                    tag.classList.toggle('active');
                    generateImages = tag.classList.contains('active');
                } else if (tag.dataset.articleType) {
                    document.querySelectorAll('.option-tag[data-article-type]').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                    articleType = tag.dataset.articleType;
                } else if (tag.dataset.length) {
                    document.querySelectorAll('.option-tag[data-length]').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                    targetLength = tag.dataset.length;
                } else {
                    tag.classList.toggle('active');
                }
            });
        });

        // ç¤ºä¾‹å¡ç‰‡ç‚¹å‡»
        document.querySelectorAll('.example-card').forEach(card => {
            card.addEventListener('click', () => {
                document.getElementById('contentInput').value = card.dataset.content;
                document.querySelector('.main-card').scrollIntoView({ behavior: 'smooth' });
            });
        });

        // æ¢å¤ç”ŸæˆæŒ‰é’®çŠ¶æ€
        function resetCreateBtn() {
            const btn = document.getElementById('createBlogBtn');
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5">
                <path d="M12 19V5M5 12l7-7 7 7"/>
            </svg>`;
            btn.title = 'ç”Ÿæˆåšå®¢';
        }

        // æ·»åŠ è¿›åº¦é¡¹
        function addProgressItem(message, type = 'info', detail = '') {
            const body = document.getElementById('progressBody');
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const item = document.createElement('div');
            item.className = `progress-item ${type}`;
            item.innerHTML = `
                <div class="time">${time}</div>
                <div class="message">${message}</div>
                ${detail ? `<div class="detail">${detail}</div>` : ''}
            `;
            body.appendChild(item);
            body.scrollTop = body.scrollHeight;
        }
        
        // æ·»åŠ æ–‡æ¡£é¢„è§ˆ
        function addDocumentPreview(fileName, preview) {
            const body = document.getElementById('progressBody');
            const item = document.createElement('div');
            item.className = 'progress-item document-preview';
            item.innerHTML = `
                <div class="preview-content" style="
                    background: rgba(78,205,196,0.05);
                    border: 1px solid rgba(78,205,196,0.2);
                    border-radius: 8px;
                    padding: 12px;
                    margin: 4px 0 8px 60px;
                    font-size: 12px;
                    color: #555;
                    line-height: 1.6;
                    max-height: 150px;
                    overflow-y: auto;
                    white-space: pre-wrap;
                    word-break: break-word;
                ">${preview}</div>
            `;
            body.appendChild(item);
            body.scrollTop = body.scrollHeight;
        }

        // æ›´æ–°æµå¼å†…å®¹
        function updateStreamItem(content) {
            const body = document.getElementById('progressBody');
            let streamItem = body.querySelector('.progress-item.stream:last-child');
            if (!streamItem || !streamItem.classList.contains('streaming')) {
                streamItem = document.createElement('div');
                streamItem.className = 'progress-item stream streaming';
                streamItem.innerHTML = `
                    <div class="time">${new Date().toLocaleTimeString('zh-CN', { hour12: false })}</div>
                    <div class="message">ğŸ“ å¤§çº²ç”Ÿæˆä¸­<span class="dots"></span></div>
                    <div class="detail"></div>
                `;
                body.appendChild(streamItem);
            }
            streamItem.querySelector('.detail').textContent = content;
            body.scrollTop = body.scrollHeight;
        }

        // å®Œæˆæµå¼
        function finishStream() {
            const streamItem = document.querySelector('.progress-item.streaming');
            if (streamItem) {
                streamItem.classList.remove('streaming');
                streamItem.classList.add('success');
                streamItem.querySelector('.message').innerHTML = 'ğŸ“ å¤§çº²ç”Ÿæˆå®Œæˆ';
            }
        }

        // å…³é—­è¿›åº¦é¢æ¿
        document.getElementById('closeProgress').addEventListener('click', () => {
            document.getElementById('progressPanel').classList.remove('show');
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        });

        // å¯¼å‡ºè¿›åº¦é¢æ¿ä¸ºå›¾ç‰‡
        document.getElementById('exportProgressBtn').addEventListener('click', async () => {
            const panel = document.getElementById('progressPanel');
            const progressBody = document.getElementById('progressBody');
            const btn = document.getElementById('exportProgressBtn');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = 'â³';
                btn.disabled = true;
                
                // ä¸´æ—¶ç§»é™¤æ»šåŠ¨é™åˆ¶ä»¥æ•è·å®Œæ•´å†…å®¹
                progressBody.style.cssText = 'max-height: none !important; overflow: visible !important;';
                
                // ä¸´æ—¶ä¸ºè¿›åº¦é¡¹è®¾ç½®ä¸é¡µé¢ä¸€è‡´çš„æ ·å¼ï¼ˆç¡®ä¿ html2canvas èƒ½æ­£ç¡®æ¸²æŸ“ï¼‰
                const progressItems = progressBody.querySelectorAll('.progress-item');
                progressItems.forEach(item => {
                    // ä¿å­˜åŸå§‹å†…è”æ ·å¼
                    item.dataset.originalStyle = item.getAttribute('style') || '';
                    // è·å–è®¡ç®—åçš„è¾¹æ¡†é¢œè‰²
                    const computedStyle = window.getComputedStyle(item);
                    const borderColor = computedStyle.borderLeftColor;
                    // è®¾ç½®ä¸é¡µé¢ä¸€è‡´çš„æ ·å¼
                    item.style.background = '#f8f9fa';
                    item.style.borderLeft = `3px solid ${borderColor}`;
                    item.style.borderRadius = '12px';
                    item.style.padding = '12px 16px';
                    item.style.marginBottom = '10px';
                });
                
                // è®¾ç½®æ–‡å­—é¢œè‰²ä¸ºé»‘è‰²
                const timeElements = progressBody.querySelectorAll('.progress-item .time');
                const messageElements = progressBody.querySelectorAll('.progress-item .message');
                const detailElements = progressBody.querySelectorAll('.progress-item .detail');
                
                timeElements.forEach(el => {
                    el.dataset.originalStyle = el.getAttribute('style') || '';
                    el.style.color = '#666';
                });
                messageElements.forEach(el => {
                    el.dataset.originalStyle = el.getAttribute('style') || '';
                    el.style.color = '#333';
                });
                detailElements.forEach(el => {
                    el.dataset.originalStyle = el.getAttribute('style') || '';
                    el.style.color = '#444';
                });
                
                // ç­‰å¾…æ ·å¼ç”Ÿæ•ˆ
                await new Promise(r => setTimeout(r, 150));
                
                // ä½¿ç”¨ html2canvas æˆªå›¾
                const canvas = await html2canvas(panel, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0
                });
                
                // æ¢å¤è¿›åº¦é¡¹æ ·å¼
                progressItems.forEach(item => {
                    const originalStyle = item.dataset.originalStyle;
                    if (originalStyle) {
                        item.setAttribute('style', originalStyle);
                    } else {
                        item.removeAttribute('style');
                    }
                });
                
                // æ¢å¤æ–‡å­—æ ·å¼
                timeElements.forEach(el => {
                    const originalStyle = el.dataset.originalStyle;
                    if (originalStyle) {
                        el.setAttribute('style', originalStyle);
                    } else {
                        el.removeAttribute('style');
                    }
                });
                messageElements.forEach(el => {
                    const originalStyle = el.dataset.originalStyle;
                    if (originalStyle) {
                        el.setAttribute('style', originalStyle);
                    } else {
                        el.removeAttribute('style');
                    }
                });
                detailElements.forEach(el => {
                    const originalStyle = el.dataset.originalStyle;
                    if (originalStyle) {
                        el.setAttribute('style', originalStyle);
                    } else {
                        el.removeAttribute('style');
                    }
                });
                
                // æ¢å¤æ ·å¼
                progressBody.style.cssText = '';
                
                // è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                link.download = `AIå·¥ä½œçŠ¶æ€_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                btn.textContent = 'âœ…';
                setTimeout(() => { btn.textContent = originalText; }, 1500);
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥:', e);
                btn.textContent = 'âŒ';
                setTimeout(() => { btn.textContent = originalText; }, 1500);
            } finally {
                btn.disabled = false;
            }
        });

        // åœæ­¢æŒ‰é’®
        document.getElementById('stopBtn').addEventListener('click', async () => {
            // è°ƒç”¨åç«¯å–æ¶ˆ API
            if (currentTaskId) {
                try {
                    const response = await fetch(`/api/tasks/${currentTaskId}/cancel`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    if (data.success) {
                        addProgressItem('â¹ï¸ ä»»åŠ¡å·²å–æ¶ˆ', 'error');
                    } else {
                        addProgressItem(`âš ï¸ å–æ¶ˆå¤±è´¥: ${data.error}`, 'error');
                    }
                } catch (e) {
                    console.error('å–æ¶ˆä»»åŠ¡å¤±è´¥:', e);
                    addProgressItem('âš ï¸ å–æ¶ˆè¯·æ±‚å¤±è´¥', 'error');
                }
            }
            
            // å…³é—­ SSE è¿æ¥
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            document.getElementById('statusBadge').textContent = 'å·²åœæ­¢';
            resetCreateBtn();
        });

        // é•¿æ–‡åšå®¢ç”ŸæˆæŒ‰é’®
        document.getElementById('createBlogBtn').addEventListener('click', async () => {
            const btn = document.getElementById('createBlogBtn');
            if (btn.disabled) return;
            
            const topic = document.getElementById('contentInput').value.trim();
            if (!topic) {
                alert('è¯·è¾“å…¥æŠ€æœ¯ä¸»é¢˜');
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.cursor = 'not-allowed';
            btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" style="animation: spin 1s linear infinite;">
                <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="32"/>
            </svg>`;
            btn.title = 'ç”Ÿæˆä¸­...';

            // æ˜¾ç¤ºè¿›åº¦é¢æ¿
            const progressPanel = document.getElementById('progressPanel');
            const progressBody = document.getElementById('progressBody');
            progressBody.innerHTML = '';
            progressPanel.classList.add('show');
            document.getElementById('statusBadge').textContent = 'å‡†å¤‡ä¸­';
            
            // æ ¹æ®ç±»å‹é€‰æ‹©ä¸åŒçš„ API
            const isStorybook = articleType === 'storybook';
            const apiUrl = isStorybook ? '/api/generate' : '/api/blog/generate';
            const taskName = isStorybook ? 'ç§‘æ™®ç»˜æœ¬' : 'åšå®¢';
            document.getElementById('progressText').textContent = `æ­£åœ¨åˆ›å»º${taskName}ç”Ÿæˆä»»åŠ¡...`;

            try {
                // æ ¹æ®ç±»å‹æ„å»ºä¸åŒçš„è¯·æ±‚ä½“
                const requestBody = isStorybook 
                    ? {
                        content: topic,
                        page_count: targetLength === 'short' ? 5 : (targetLength === 'medium' ? 8 : 12),
                        target_audience: 'æŠ€æœ¯å°ç™½',
                        style: 'å¯çˆ±å¡é€šé£',
                        generate_images: true
                    }
                    : {
                        topic: topic,
                        article_type: articleType,
                        target_audience: 'intermediate',
                        target_length: targetLength,
                        document_ids: getReadyDocumentIds(),
                        image_style: getSelectedImageStyle()
                    };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (!data.success) {
                    addProgressItem(`âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥: ${data.error}`, 'error');
                    return;
                }

                currentTaskId = data.task_id;
                addProgressItem(`âœ… ${taskName}ç”Ÿæˆä»»åŠ¡å·²åˆ›å»º: ${currentTaskId}`);

                // è®¢é˜… SSE
                eventSource = new EventSource(`/api/tasks/${currentTaskId}/stream`);

                eventSource.addEventListener('connected', (e) => {
                    addProgressItem('ğŸ”— å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                    document.getElementById('statusBadge').textContent = 'è¿è¡Œä¸­';
                });

                eventSource.addEventListener('progress', (e) => {
                    const d = JSON.parse(e.data);
                    const icon = getStageIcon(d.stage);
                    addProgressItem(`${icon} ${d.message}`, d.stage === 'error' ? 'error' : 'info');
                    document.getElementById('progressText').textContent = d.message;
                });

                // ç›‘å¬åç«¯æ—¥å¿—
                eventSource.addEventListener('log', (e) => {
                    const d = JSON.parse(e.data);
                    const logger = d.logger || '';
                    const message = d.message || '';
                    
                    // æ ¹æ®æ—¥å¿—æ¥æºæ·»åŠ ä¸åŒå›¾æ ‡
                    let icon = 'ğŸ“';
                    if (logger === 'generator') icon = 'âš™ï¸';
                    else if (logger === 'researcher') icon = 'ğŸ”';
                    else if (logger === 'planner') icon = 'ğŸ“‹';
                    else if (logger === 'writer') icon = 'âœï¸';
                    else if (logger === 'questioner') icon = 'â“';
                    else if (logger === 'coder') icon = 'ğŸ’»';
                    else if (logger === 'artist') icon = 'ğŸ¨';
                    else if (logger === 'reviewer') icon = 'âœ…';
                    else if (logger === 'assembler') icon = 'ğŸ“¦';
                    else if (logger === 'search_service') icon = 'ğŸŒ';
                    else if (logger === 'blog_service') icon = 'ğŸ–¼ï¸';
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ–‡æ¡£é¢„è§ˆå†…å®¹
                    if (message.startsWith('__DOC_PREVIEW__') && message.endsWith('__END_PREVIEW__')) {
                        const preview = message.replace('__DOC_PREVIEW__', '').replace('__END_PREVIEW__', '');
                        addDocumentPreview('', preview);
                        return;
                    }
                    
                    // åˆ¤æ–­æ˜¯å¦ä¸ºæˆåŠŸæ¶ˆæ¯
                    const isSuccess = message.includes('å®Œæˆ') || message.includes('æˆåŠŸ');
                    addProgressItem(`${icon} ${message}`, isSuccess ? 'success' : 'info');
                    
                    // æ›´æ–°åº•éƒ¨çŠ¶æ€æ 
                    document.getElementById('progressText').textContent = message;
                });

                eventSource.addEventListener('complete', (e) => {
                    const d = JSON.parse(e.data);
                    addProgressItem(`ğŸ‰ ${taskName}ç”Ÿæˆå®Œæˆï¼`, 'success');
                    document.getElementById('statusBadge').textContent = 'å·²å®Œæˆ';
                    document.getElementById('progressText').textContent = 'ç”Ÿæˆå®Œæˆ';
                    resetCreateBtn();
                    
                    // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„ç»“æœ
                    if (isStorybook) {
                        displayResult(d.outputs);
                    } else {
                        displayBlogResult(d);
                    }
                    
                    // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨
                    loadHistory();
                    
                    eventSource.close();
                    eventSource = null;
                });

                // å¤§çº²æµå¼æ¨é€ï¼ˆåšå®¢å’Œç»˜æœ¬é€šç”¨ï¼‰
                eventSource.addEventListener('stream', (e) => {
                    const d = JSON.parse(e.data);
                    if (d.stage === 'outline') {
                        updateStreamItem(d.accumulated);
                    }
                });

                // ç´ ææ”¶é›†ç»“æœ
                eventSource.addEventListener('result', (e) => {
                    const d = JSON.parse(e.data);
                    if (d.type === 'researcher_complete') {
                        const data = d.data;
                        // å±•ç¤ºçŸ¥è¯†æ¥æºç»Ÿè®¡
                        if (data.document_count > 0 || data.web_count > 0) {
                            addProgressItem(`ğŸ“Š çŸ¥è¯†æ¥æº: æ–‡æ¡£ ${data.document_count} æ¡, ç½‘ç»œ ${data.web_count} æ¡`, 'info');
                        }
                        // å±•ç¤ºæ ¸å¿ƒæ¦‚å¿µ
                        if (data.key_concepts && data.key_concepts.length > 0) {
                            addProgressItem(`ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ: ${data.key_concepts.join(', ')}`, 'success');
                        }
                    }
                });

                // ç§‘æ™®ç»˜æœ¬ç‰¹æœ‰çš„äº‹ä»¶ç›‘å¬
                if (isStorybook) {

                    eventSource.addEventListener('result', (e) => {
                        const d = JSON.parse(e.data);
                        if (d.type === 'concepts') {
                            addProgressItem(`ğŸ” è¯†åˆ«åˆ°æŠ€æœ¯æ¦‚å¿µ: ${d.data.concepts.join(', ')}`, 'success');
                        } else if (d.type === 'metaphors') {
                            addProgressItem(`ğŸ’¡ æ‰¾åˆ°æ¯”å–»: ${d.data.metaphors.join(', ')}`, 'success');
                        } else if (d.type === 'outline_complete') {
                            finishStream();
                            addProgressItem(`ğŸ“š å¤§çº²å®Œæˆ: ${d.data.title} (${d.data.page_count} é¡µ)`, 'success');
                        } else if (d.type === 'page_content') {
                            addProgressItem(`ğŸ“– ç¬¬ ${d.data.page_number} é¡µ: ${d.data.title}`, 'info');
                        } else if (d.type === 'page_image') {
                            addProgressItem(`ğŸ–¼ï¸ ç¬¬ ${d.data.page_number} é¡µé…å›¾å·²ç”Ÿæˆ`, 'success');
                        }
                    });
                }

                eventSource.addEventListener('error', (e) => {
                    if (e.data) {
                        const d = JSON.parse(e.data);
                        addProgressItem(`âŒ é”™è¯¯: ${d.message}`, 'error');
                    }
                    document.getElementById('statusBadge').textContent = 'é”™è¯¯';
                    resetCreateBtn();
                });

                eventSource.onerror = () => {
                    if (eventSource && eventSource.readyState === EventSource.CLOSED) {
                        addProgressItem('ğŸ”Œ è¿æ¥å·²å…³é—­');
                        resetCreateBtn();
                    }
                };

            } catch (error) {
                addProgressItem(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                resetCreateBtn();
            }
        });

        // è·å–é˜¶æ®µå›¾æ ‡
        function getStageIcon(stage) {
            const icons = {
                'start': 'ğŸš€',
                'researcher': 'ğŸ”',
                'planner': 'ğŸ“‹',
                'writer': 'âœï¸',
                'questioner': 'â“',
                'deepen_content': 'ğŸ“š',
                'coder': 'ğŸ’»',
                'artist': 'ğŸ¨',
                'reviewer': 'âœ…',
                'revision': 'ğŸ”„',
                'assembler': 'ğŸ“¦'
            };
            return icons[stage] || 'âš™ï¸';
        }

        // ä¿å­˜å½“å‰åšå®¢ç»“æœç”¨äºä¸‹è½½
        let currentBlogResult = null;

        // æ˜¾ç¤ºåšå®¢ç»“æœ
        function displayBlogResult(result) {
            currentBlogResult = result;
            
            document.getElementById('resultTitle').textContent = result.outline?.title || 'æŠ€æœ¯åšå®¢';
            document.getElementById('resultMeta').innerHTML = `
                <span class="meta-tag sections">ğŸ“š ${result.sections_count || 0} ç« èŠ‚</span>
                <span class="meta-tag code">ğŸ’» ${result.code_blocks_count || 0} ä»£ç å—</span>
                <span class="meta-tag images">ğŸ¨ ${result.images_count || 0} é…å›¾</span>
                <span class="meta-tag score">â­ è¯„åˆ† ${result.review_score || 0}</span>
            `;

            const pagesContainer = document.getElementById('resultPages');
            pagesContainer.innerHTML = '';

            // æ˜¾ç¤º Markdown å†…å®¹
            if (result.markdown) {
                const markdownEl = document.createElement('div');
                markdownEl.className = 'page-item';
                markdownEl.innerHTML = `
                    <div class="page-header">
                        <div class="page-number">ğŸ“„</div>
                        <div class="page-title">å®Œæ•´åšå®¢å†…å®¹</div>
                        <div style="margin-left: auto; display: flex; gap: 10px;">
                            <button class="export-image-btn" style="padding: 8px 16px; background: linear-gradient(135deg, #FF6B35, #FF8E53); border: none; border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer;">
                                ğŸ“· å¯¼å‡ºå›¾ç‰‡
                            </button>
                            <button class="download-markdown-btn" style="padding: 8px 16px; background: linear-gradient(135deg, #4ECDC4, #44A08D); border: none; border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer;">
                                ğŸ“¥ ä¸‹è½½ Markdown
                            </button>
                        </div>
                    </div>
                    <div class="markdown-body" id="markdownContent"></div>
                `;
                pagesContainer.appendChild(markdownEl);
                
                // ä¸ºæŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                const downloadBtn = markdownEl.querySelector('.download-markdown-btn');
                const exportBtn = markdownEl.querySelector('.export-image-btn');
                
                console.log('[displayBlogResult] æŸ¥æ‰¾æŒ‰é’®:', { downloadBtn, exportBtn });
                
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', downloadMarkdown);
                    console.log('[displayBlogResult] ä¸‹è½½æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
                }
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportMarkdownAsImage);
                    console.log('[displayBlogResult] å¯¼å‡ºæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
                }
                
                // ä½¿ç”¨ marked.js æ¸²æŸ“ Markdown
                renderMarkdown(result.markdown);
                
                // æ˜¾ç¤ºä¿å­˜è·¯å¾„
                if (result.saved_path) {
                    addProgressItem(`ğŸ“ å·²è‡ªåŠ¨ä¿å­˜åˆ°: ${result.saved_path}`, 'success');
                }
            }

            document.getElementById('resultSection').classList.add('show');
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // æ¸²æŸ“ Markdown å†…å®¹
        function renderMarkdown(markdown) {
            // é¢„å¤„ç†ï¼šä¿®å¤å›¾ç‰‡è·¯å¾„ï¼ˆå°† ./images/ è½¬æ¢ä¸º /outputs/images/ï¼‰
            let processedMarkdown = markdown.replace(/\]\(\.\/images\//g, '](/outputs/images/');
            
            // é¢„å¤„ç†ï¼šç¡®ä¿åˆ†å‰²çº¿ --- å‰åæœ‰ç©ºè¡Œï¼ˆé¿å…è¢«è§£æä¸ºæ ‡é¢˜ï¼‰
            // åªå¤„ç†ç‹¬ç«‹çš„åˆ†å‰²çº¿ï¼ˆè¡Œé¦–çš„ ---ï¼‰ï¼Œä¸å¤„ç†è¡¨æ ¼åˆ†éš”ç¬¦ï¼ˆåŒ…å« | çš„è¡Œï¼‰
            processedMarkdown = processedMarkdown.replace(/^(-{3,})$/gm, '\n$1\n');
            // å¤„ç† ---# ç´§è·Ÿçš„æƒ…å†µï¼ˆæ²¡æœ‰æ¢è¡Œï¼‰
            processedMarkdown = processedMarkdown.replace(/^(-{3,})([#])/gm, '$1\n\n$2');
            
            // é…ç½® marked
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (e) {}
                    }
                    return code;
                },
                breaks: true,
                gfm: true
            });
            
            // æ¸²æŸ“ Markdown
            const container = document.getElementById('markdownContent');
            container.innerHTML = marked.parse(processedMarkdown);
            
            // æ¸²æŸ“ Mermaid å›¾è¡¨
            setTimeout(async () => {
                const mermaidBlocks = container.querySelectorAll('pre code.language-mermaid');
                console.log('æ‰¾åˆ° Mermaid ä»£ç å—:', mermaidBlocks.length);
                
                if (typeof mermaid === 'undefined' || mermaidBlocks.length === 0) return;
                
                // åˆå§‹åŒ– Mermaid
                mermaid.initialize({ 
                    startOnLoad: false,
                    theme: 'default',
                    securityLevel: 'loose',
                    flowchart: {
                        htmlLabels: true,
                        useMaxWidth: true,
                        curve: 'basis'
                    }
                });
                
                // é€ä¸ªæ¸²æŸ“ Mermaid å›¾è¡¨
                for (let i = 0; i < mermaidBlocks.length; i++) {
                    const block = mermaidBlocks[i];
                    let code = block.textContent;
                    
                    // æ¸…ç†ç‰¹æ®Šå¼•å·
                    code = code.replace(/[""'']/g, '"');
                    
                    const div = document.createElement('div');
                    div.className = 'mermaid';
                    div.id = 'mermaid-' + i;
                    
                    try {
                        const { svg } = await mermaid.render('mermaid-graph-' + i, code);
                        div.innerHTML = svg;
                        block.parentElement.replaceWith(div);
                        console.log('Mermaid å›¾è¡¨ ' + i + ' æ¸²æŸ“æˆåŠŸ');
                    } catch (e) {
                        console.warn('Mermaid å›¾è¡¨ ' + i + ' æ¸²æŸ“å¤±è´¥:', e.message);
                        // æ¸²æŸ“å¤±è´¥æ—¶æ˜¾ç¤ºåŸå§‹ä»£ç 
                        div.innerHTML = '<pre style="background:#fff3cd;padding:10px;border-radius:5px;"><code>' + code + '</code></pre><p style="color:#856404;font-size:12px;">âš ï¸ å›¾è¡¨æ¸²æŸ“å¤±è´¥</p>';
                        block.parentElement.replaceWith(div);
                    }
                }
            }, 200);
        }

        // ä¸‹è½½ Markdown (åŒ…å«æœ¬åœ°å›¾ç‰‡)
        async function downloadMarkdown() {
            console.log('[downloadMarkdown] å¼€å§‹ä¸‹è½½ï¼ŒcurrentBlogResult:', currentBlogResult);
            
            if (!currentBlogResult || !currentBlogResult.markdown) {
                console.error('[downloadMarkdown] æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹');
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹');
                return;
            }
            
            const title = currentBlogResult.outline?.title || 'blog';
            const safeTitle = title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5_-]/g, '_').substring(0, 50);
            console.log('[downloadMarkdown] æ ‡é¢˜:', title, 'å®‰å…¨æ ‡é¢˜:', safeTitle);
            
            // æ‰¾åˆ°æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const btns = document.querySelectorAll('.download-btn');
            let btn = null;
            btns.forEach(b => { if (b.textContent.includes('ä¸‹è½½ Markdown')) btn = b; });
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = 'â³ ä¸‹è½½ä¸­...';
                btn.disabled = true;
                console.log('[downloadMarkdown] æŒ‰é’®çŠ¶æ€å·²æ›´æ–°');
            }
            
            try {
                console.log('[downloadMarkdown] è°ƒç”¨ API: /api/export/markdown');
                // è°ƒç”¨åç«¯ API å¯¼å‡ºåŒ…å«å›¾ç‰‡çš„ Markdown
                const response = await fetch('/api/export/markdown', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        markdown: currentBlogResult.markdown,
                        title: title
                    })
                });
                
                console.log('[downloadMarkdown] API å“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'å¯¼å‡ºå¤±è´¥');
                }
                
                // è·å– ZIP æ–‡ä»¶
                const blob = await response.blob();
                console.log('[downloadMarkdown] è·å¾— ZIP æ–‡ä»¶ï¼Œå¤§å°:', blob.size);
                
                const url = URL.createObjectURL(blob);
                
                // ä¸‹è½½ ZIP æ–‡ä»¶
                const a = document.createElement('a');
                a.href = url;
                a.download = `${safeTitle}_${new Date().toISOString().slice(0, 10)}.zip`;
                document.body.appendChild(a);
                console.log('[downloadMarkdown] è§¦å‘ä¸‹è½½:', a.download);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                if (btn) {
                    btn.innerHTML = 'âœ… å·²ä¸‹è½½';
                    setTimeout(() => { btn.innerHTML = originalText; }, 1500);
                }
                console.log('[downloadMarkdown] ä¸‹è½½å®Œæˆ');
            } catch (error) {
                console.error('[downloadMarkdown] ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
                if (btn) btn.innerHTML = originalText;
            } finally {
                if (btn) btn.disabled = false;
            }
        }
        
        // å¯¼å‡º Markdown é¢„è§ˆä¸ºå›¾ç‰‡
        async function exportMarkdownAsImage() {
            const markdownContent = document.getElementById('markdownContent');
            if (!markdownContent) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹');
                return;
            }
            
            const title = currentBlogResult?.outline?.title || 'blog';
            const safeTitle = title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5_-]/g, '_').substring(0, 50);
            const filename = `${safeTitle}_${new Date().toISOString().slice(0, 10)}.png`;
            
            // æ‰¾åˆ°æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const btns = document.querySelectorAll('.download-btn');
            let btn = null;
            btns.forEach(b => { if (b.textContent.includes('å¯¼å‡ºå›¾ç‰‡')) btn = b; });
            // ä¹Ÿå°è¯•æ‰¾ export-image-btn
            if (!btn) {
                btn = document.querySelector('.export-image-btn');
            }
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = 'â³ å¯¼å‡ºä¸­...';
                btn.disabled = true;
            }
            
            try {
                // ä¸´æ—¶ç§»é™¤æ»šåŠ¨é™åˆ¶ä»¥æ•è·å®Œæ•´å†…å®¹
                const originalMaxHeight = markdownContent.style.maxHeight;
                const originalOverflow = markdownContent.style.overflow;
                markdownContent.style.maxHeight = 'none';
                markdownContent.style.overflow = 'visible';
                
                // å°†æ‰€æœ‰å›¾ç‰‡è½¬æ¢ä¸º base64ï¼ˆè§£å†³è·¨åŸŸé—®é¢˜ï¼‰
                const images = markdownContent.querySelectorAll('img');
                await Promise.all(Array.from(images).map(async (img) => {
                    try {
                        // è·³è¿‡å·²ç»æ˜¯ base64 çš„å›¾ç‰‡
                        if (img.src.startsWith('data:')) return;
                        
                        // ä½¿ç”¨ fetch è·å–å›¾ç‰‡å¹¶è½¬æ¢ä¸º base64
                        const response = await fetch(img.src);
                        const blob = await response.blob();
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });
                        img.src = base64;
                    } catch (e) {
                        console.warn('å›¾ç‰‡è½¬æ¢å¤±è´¥:', img.src, e);
                    }
                }));
                
                // ä½¿ç”¨ html2canvas æˆªå›¾ï¼ˆç™½è‰²èƒŒæ™¯ï¼‰
                const canvas = await html2canvas(markdownContent, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    imageTimeout: 15000
                });
                
                // æ¢å¤æ ·å¼
                markdownContent.style.maxHeight = originalMaxHeight;
                markdownContent.style.overflow = originalOverflow;
                
                // æ£€æŸ¥ canvas æ˜¯å¦æœ‰æ•ˆ
                if (canvas.width === 0 || canvas.height === 0) {
                    throw new Error('ç”Ÿæˆçš„å›¾ç‰‡ä¸ºç©ºï¼Œè¯·æ£€æŸ¥å†…å®¹');
                }
                
                // ä½¿ç”¨ toBlob ä¸‹è½½å›¾ç‰‡ï¼ˆæ›´å¯é ï¼‰
                canvas.toBlob((blob) => {
                    if (!blob || blob.size === 0) {
                        console.error('ç”Ÿæˆçš„ Blob ä¸ºç©º');
                        alert('å¯¼å‡ºå¤±è´¥ï¼šç”Ÿæˆçš„å›¾ç‰‡ä¸ºç©º');
                        if (btn) {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                        return;
                    }
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = url;
                    link.click();
                    
                    // æ¸…ç†
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    
                    if (btn) {
                        btn.innerHTML = 'âœ… å·²å¯¼å‡º';
                        setTimeout(() => { btn.innerHTML = originalText; }, 1500);
                    }
                }, 'image/png', 1.0);
                
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥:', e);
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
                if (btn) btn.innerHTML = originalText;
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(result) {
            document.getElementById('resultTitle').textContent = result.title || 'æŠ€æœ¯ç§‘æ™®ç»˜æœ¬';
            document.getElementById('resultMeta').textContent = `${result.total_pages} é¡µ Â· ${result.core_metaphor || ''}`;

            const pagesContainer = document.getElementById('resultPages');
            pagesContainer.innerHTML = '';

            (result.pages || []).forEach(page => {
                const pageEl = document.createElement('div');
                pageEl.className = 'page-item';
                
                // æ„å»ºæ ‡ç­¾
                let tagsHtml = '<div class="page-tags">';
                if (page.metaphor) tagsHtml += `<span class="page-tag metaphor">ğŸ’¡ ${page.metaphor}</span>`;
                if (page.tech_point) tagsHtml += `<span class="page-tag tech">ğŸ”§ ${page.tech_point}</span>`;
                if (page.real_world_example) tagsHtml += `<span class="page-tag example">ğŸŒ ${page.real_world_example}</span>`;
                tagsHtml += '</div>';
                
                // æ„å»ºè¦ç‚¹æ€»ç»“
                let takeawayHtml = '';
                if (page.key_takeaway) {
                    takeawayHtml = `<div class="page-takeaway">ğŸ“Œ <strong>è¦ç‚¹ï¼š</strong>${page.key_takeaway}</div>`;
                }
                
                pageEl.innerHTML = `
                    <div class="page-header">
                        <div class="page-number">${page.page_number}</div>
                        <div class="page-title">${page.title}</div>
                    </div>
                    ${page.image_url ? `<div class="page-image"><img src="${page.image_url}" alt="${page.title}"></div>` : ''}
                    <div class="page-content">${page.content}</div>
                    ${tagsHtml}
                    ${takeawayHtml}
                `;
                pagesContainer.appendChild(pageEl);
            });

            document.getElementById('resultSection').classList.add('show');
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        // ========== å†å²è®°å½•åŠŸèƒ½ ==========
        
        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            console.log('[loadHistory] å¼€å§‹åŠ è½½å†å²è®°å½•...');
            try {
                const response = await fetch('/api/history?limit=20');
                console.log('[loadHistory] API å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('[loadHistory] API è¿”å›æ•°æ®:', data);
                if (data.success && data.records) {
                    console.log('[loadHistory] è®°å½•æ•°é‡:', data.records.length);
                    renderHistoryList(data.records);
                } else {
                    console.log('[loadHistory] æ— è®°å½•æˆ–è¯·æ±‚å¤±è´¥');
                    renderHistoryList([]);
                }
            } catch (error) {
                console.error('[loadHistory] åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
        function renderHistoryList(records) {
            const grid = document.getElementById('historyGrid');
            if (!records || records.length === 0) {
                grid.innerHTML = '<div class="history-empty">æš‚æ— å†å²è®°å½•ï¼Œç”Ÿæˆåšå®¢åå°†è‡ªåŠ¨ä¿å­˜</div>';
                return;
            }
            
            grid.innerHTML = records.map(record => {
                const coverHtml = record.cover_image 
                    ? `<img src="/outputs/images/${record.cover_image.split('/').pop()}" alt="å°é¢">`
                    : 'ğŸ“';
                const timeStr = formatTime(record.created_at);
                const typeMap = { 'tutorial': 'æ•™ç¨‹', 'problem-solution': 'é—®é¢˜è§£å†³', 'comparison': 'å¯¹æ¯”åˆ†æ', 'storybook': 'ç»˜æœ¬' };
                const lengthMap = { 'short': 'çŸ­æ–‡', 'medium': 'ä¸­ç­‰', 'long': 'é•¿æ–‡' };
                
                return `
                    <div class="history-card" data-id="${record.id}">
                        <button class="delete-btn" onclick="deleteHistory(event, '${record.id}')" title="åˆ é™¤">Ã—</button>
                        <div class="history-cover">${coverHtml}</div>
                        <div class="history-content">
                            <div class="history-topic">${escapeHtml(record.topic)}</div>
                            <div class="history-meta">
                                <span>ğŸ“š ${record.sections_count || 0} ç« </span>
                                <span>ğŸ’» ${record.code_blocks_count || 0} ä»£ç </span>
                                <span>â­ ${record.review_score || 0}</span>
                            </div>
                            <div class="history-time">${timeStr} Â· ${typeMap[record.article_type] || 'æ•™ç¨‹'} Â· ${lengthMap[record.target_length] || 'ä¸­ç­‰'}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            grid.querySelectorAll('.history-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-btn')) return;
                    loadHistoryDetail(card.dataset.id);
                });
            });
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            if (!timeStr) return '';
            const date = new Date(timeStr);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} åˆ†é’Ÿå‰`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} å°æ—¶å‰`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)} å¤©å‰`;
            return date.toLocaleDateString('zh-CN');
        }
        
        // åŠ è½½å†å²è¯¦æƒ…
        async function loadHistoryDetail(historyId) {
            try {
                const response = await fetch(`/api/history/${historyId}`);
                const data = await response.json();
                if (data.success && data.record) {
                    const record = data.record;
                    let outline = {};
                    try {
                        outline = JSON.parse(record.outline || '{}');
                    } catch (e) {}
                    
                    // æ˜¾ç¤ºåšå®¢ç»“æœ
                    displayBlogResult({
                        markdown: record.markdown_content,
                        outline: outline,
                        sections_count: record.sections_count,
                        code_blocks_count: record.code_blocks_count,
                        images_count: record.images_count,
                        review_score: record.review_score
                    });
                }
            } catch (error) {
                console.error('åŠ è½½å†å²è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½å†å²è®°å½•å¤±è´¥');
            }
        }
        
        // åˆ é™¤å†å²è®°å½•
        async function deleteHistory(event, historyId) {
            event.stopPropagation();
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/history/${historyId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    loadHistory(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤å†å²è®°å½•å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadHistory();
                loadImageStyles();
                initAdvancedOptions();
            });
        } else {
            // DOM å·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥æ‰§è¡Œ
            loadHistory();
            loadImageStyles();
            initAdvancedOptions();
        }
        
        // ========== é«˜çº§é€‰é¡¹åŠŸèƒ½ ==========
        
        // åŠ è½½å›¾ç‰‡é£æ ¼åˆ—è¡¨
        async function loadImageStyles() {
            try {
                const response = await fetch('/api/image-styles');
                const data = await response.json();
                if (data.success && data.styles) {
                    const select = document.getElementById('imageStyleSelect');
                    select.innerHTML = data.styles.map(style => 
                        `<option value="${style.id}" ${style.default ? 'selected' : ''}>${style.icon} ${style.name}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡é£æ ¼åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('imageStyleSelect').innerHTML = '<option value="">é»˜è®¤é£æ ¼</option>';
            }
        }
        
        // åˆå§‹åŒ–é«˜çº§é€‰é¡¹äº¤äº’ï¼ˆå¯æŠ˜å ï¼‰
        function initAdvancedOptions() {
            const advancedBtn = document.getElementById('advancedOptionsBtn');
            const advancedPanel = document.getElementById('advancedOptionsPanel');
            
            if (advancedBtn && advancedPanel) {
                advancedBtn.addEventListener('click', () => {
                    const isVisible = advancedPanel.style.display !== 'none';
                    advancedPanel.style.display = isVisible ? 'none' : 'block';
                    advancedBtn.classList.toggle('active', !isVisible);
                });
            }
        }
        
        // è·å–é€‰ä¸­çš„å›¾ç‰‡é£æ ¼
        function getSelectedImageStyle() {
            const select = document.getElementById('imageStyleSelect');
            return select ? select.value : '';
        }
        
        // ========== vibe-reviewer åŠŸèƒ½ ==========
        
        // åŠ è½½æ•™ç¨‹åˆ—è¡¨
        async function loadTutorials() {
            try {
                const response = await fetch('/api/reviewer/tutorials');
                const data = await response.json();
                if (data.success) {
                    renderTutorialCards(data.tutorials);
                }
            } catch (error) {
                console.error('åŠ è½½æ•™ç¨‹åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“æ•™ç¨‹å¡ç‰‡
        function renderTutorialCards(tutorials) {
            const container = document.getElementById('tutorialCards');
            if (!tutorials || tutorials.length === 0) {
                container.innerHTML = '<div style="color: #999; font-size: 13px; padding: 20px; text-align: center;">æš‚æ— æ•™ç¨‹ï¼Œè¯·æ·»åŠ  Git ä»“åº“ URL</div>';
                return;
            }
            
            container.innerHTML = tutorials.map(t => `
                <div class="tutorial-card" data-id="${t.id}" style="
                    background: rgba(255,255,255,0.8);
                    border-radius: 12px;
                    padding: 16px;
                    border: 1px solid rgba(0,0,0,0.1);
                    cursor: pointer;
                    transition: all 0.3s;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-size: 15px; font-weight: 600; color: #333;">${t.name}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">${t.git_url}</div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            ${t.overall_score && t.overall_score > 0 ? `
                                <div style="
                                    width: 40px; height: 40px;
                                    border-radius: 50%;
                                    background: ${t.overall_score >= 80 ? '#4ECDC4' : t.overall_score >= 60 ? '#FFD166' : '#ff6b6b'};
                                    color: white;
                                    display: flex; align-items: center; justify-content: center;
                                    font-size: 14px; font-weight: 600;
                                ">${Math.round(t.overall_score)}</div>
                            ` : ''}
                            <span style="
                                padding: 4px 10px;
                                background: ${t.status === 'completed' ? 'rgba(78,205,196,0.2)' : t.status === 'evaluating' ? 'rgba(100,149,237,0.2)' : 'rgba(255,209,102,0.2)'};
                                color: ${t.status === 'completed' ? '#4ECDC4' : t.status === 'evaluating' ? '#6495ED' : '#FFD166'};
                                border-radius: 12px;
                                font-size: 12px;
                            ">${t.status === 'completed' ? 'âœ… å·²å®Œæˆ' : t.status === 'pending' ? 'â³ å¾…è¯„ä¼°' : t.status === 'evaluating' ? 'âš™ï¸ è¯„ä¼°ä¸­' : t.status}</span>
                        </div>
                    </div>
                    ${t.total_issues > 0 ? `
                        <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 12px;">
                            <span style="color: #ff6b6b;">ğŸ”´ ${t.high_issues} é«˜</span>
                            <span style="color: #FFD166;">ğŸŸ¡ ${t.medium_issues} ä¸­</span>
                            <span style="color: #4ECDC4;">ğŸŸ¢ ${t.low_issues} ä½</span>
                            <span style="color: #666;">å…± ${t.total_chapters} ç« èŠ‚</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            container.querySelectorAll('.tutorial-card').forEach(card => {
                card.addEventListener('click', () => {
                    viewTutorialDetail(card.dataset.id);
                });
            });
        }
        
        // æ·»åŠ æ•™ç¨‹
        document.getElementById('startReviewBtn')?.addEventListener('click', async () => {
            const gitUrl = document.getElementById('gitUrlInput').value.trim();
            if (!gitUrl) {
                alert('è¯·è¾“å…¥ Git ä»“åº“ URL');
                return;
            }
            
            const enableSearch = document.querySelector('#reviewerOptions .option-tag[data-search="true"]')?.classList.contains('active') ?? true;
            
            try {
                const response = await fetch('/api/reviewer/tutorials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        git_url: gitUrl,
                        enable_search: enableSearch,
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('gitUrlInput').value = '';
                    loadTutorials();
                    alert('æ•™ç¨‹å·²æ·»åŠ ï¼ç‚¹å‡»æ•™ç¨‹å¡ç‰‡å¯è§¦å‘è¯„ä¼°ã€‚');
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ·»åŠ æ•™ç¨‹å¤±è´¥:', error);
                alert('æ·»åŠ æ•™ç¨‹å¤±è´¥');
            }
        });
        
        // æŸ¥çœ‹æ•™ç¨‹è¯¦æƒ…
        async function viewTutorialDetail(tutorialId) {
            try {
                const response = await fetch(`/api/reviewer/tutorials/${tutorialId}`);
                const data = await response.json();
                if (data.success) {
                    const t = data.tutorial;
                    showTutorialDetailModal(t);
                }
            } catch (error) {
                console.error('è·å–æ•™ç¨‹è¯¦æƒ…å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºæ•™ç¨‹è¯¦æƒ…å¼¹çª—
        function showTutorialDetailModal(tutorial) {
            const modal = document.createElement('div');
            modal.className = 'tutorial-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const statusText = {
                'pending': 'â³ å¾…è¯„ä¼°',
                'cloning': 'ğŸ“¥ å…‹éš†ä¸­',
                'scanning': 'ğŸ” æ‰«æä¸­',
                'evaluating': 'âš™ï¸ è¯„ä¼°ä¸­',
                'completed': 'âœ… å·²å®Œæˆ',
                'failed': 'âŒ å¤±è´¥'
            };
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 16px; padding: 24px;
                    max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin: 0; font-size: 20px; color: #333;">${tutorial.name}</h2>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">${tutorial.git_url}</div>
                        </div>
                        <button onclick="this.closest('.tutorial-modal').remove()" style="
                            background: none; border: none; font-size: 24px; cursor: pointer; color: #999;
                        ">Ã—</button>
                    </div>
                    
                    <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                        <div style="
                            flex: 1; background: linear-gradient(135deg, #4ECDC4, #45B7AA);
                            border-radius: 12px; padding: 16px; color: white; text-align: center;
                        ">
                            <div style="font-size: 32px; font-weight: 700;">${tutorial.overall_score ? tutorial.overall_score.toFixed(2) : '-'}</div>
                            <div style="font-size: 12px; opacity: 0.9;">ç»¼åˆè¯„åˆ†</div>
                        </div>
                        <div style="flex: 1; background: #f5f5f5; border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #333;">${tutorial.total_chapters || 0}</div>
                            <div style="font-size: 12px; color: #666;">ç« èŠ‚æ•°</div>
                        </div>
                        <div style="flex: 1; background: #f5f5f5; border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #333;">${tutorial.total_issues || 0}</div>
                            <div style="font-size: 12px; color: #666;">é—®é¢˜æ•°</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                        <span style="padding: 4px 12px; background: rgba(255,107,107,0.2); color: #ff6b6b; border-radius: 12px; font-size: 12px;">
                            ğŸ”´ ${tutorial.high_issues || 0} é«˜
                        </span>
                        <span style="padding: 4px 12px; background: rgba(255,209,102,0.2); color: #FFD166; border-radius: 12px; font-size: 12px;">
                            ğŸŸ¡ ${tutorial.medium_issues || 0} ä¸­
                        </span>
                        <span style="padding: 4px 12px; background: rgba(78,205,196,0.2); color: #4ECDC4; border-radius: 12px; font-size: 12px;">
                            ğŸŸ¢ ${tutorial.low_issues || 0} ä½
                        </span>
                        <span style="padding: 4px 12px; background: rgba(0,0,0,0.1); color: #666; border-radius: 12px; font-size: 12px;">
                            ${statusText[tutorial.status] || tutorial.status}
                        </span>
                    </div>
                    
                    <div style="background: #f9f9f9; border-radius: 10px; padding: 12px 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label style="font-size: 13px; color: #666; white-space: nowrap;">è¯„ä¼°ç« èŠ‚æ•°:</label>
                            <input type="number" id="maxChaptersInput" value="20" min="1" max="100" style="
                                flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px;
                                font-size: 14px; width: 80px;
                            ">
                            <span style="font-size: 12px; color: #999;">ï¼ˆ1-100ï¼Œ0=å…¨éƒ¨ï¼‰</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="const maxChapters = parseInt(document.getElementById('maxChaptersInput').value) || 20; startEvaluation(${tutorial.id}, maxChapters); this.closest('.tutorial-modal').remove();" style="
                            flex: 1; padding: 12px; background: linear-gradient(135deg, #4ECDC4, #45B7AA);
                            border: none; border-radius: 10px; color: white; font-size: 14px; cursor: pointer;
                        ">ğŸš€ ${tutorial.status === 'completed' ? 'é‡æ–°è¯„ä¼°' : 'å¼€å§‹è¯„ä¼°'}</button>
                        <button onclick="viewChapters(${tutorial.id}); this.closest('.tutorial-modal').remove();" style="
                            flex: 1; padding: 12px; background: #f5f5f5;
                            border: none; border-radius: 10px; color: #333; font-size: 14px; cursor: pointer;
                        ">ğŸ“š æŸ¥çœ‹ç« èŠ‚</button>
                        ${tutorial.status === 'completed' ? `
                        <button onclick="exportReport(${tutorial.id}); this.closest('.tutorial-modal').remove();" style="
                            padding: 12px 16px; background: rgba(78,205,196,0.1);
                            border: none; border-radius: 10px; color: #4ECDC4; font-size: 14px; cursor: pointer;
                        ">ğŸ“„ å¯¼å‡ºæŠ¥å‘Š</button>
                        ` : ''}
                        <button onclick="deleteTutorial(${tutorial.id}); this.closest('.tutorial-modal').remove();" style="
                            padding: 12px 16px; background: rgba(255,107,107,0.1);
                            border: none; border-radius: 10px; color: #ff6b6b; font-size: 14px; cursor: pointer;
                        ">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }
        
        // å¼€å§‹è¯„ä¼° (ä½¿ç”¨ SSE å®æ—¶è¿›åº¦)
        let reviewerEventSource = null;
        
        function startEvaluation(tutorialId, maxChapters = 20) {
            // æ˜¾ç¤ºè¿›åº¦é¢æ¿ (å¤ç”¨ vibe-blog çš„è¿›åº¦é¢æ¿)
            const progressPanel = document.getElementById('progressPanel');
            const progressBody = document.getElementById('progressBody');
            const statusBadge = document.getElementById('statusBadge');
            const progressText = document.getElementById('progressText');
            
            progressPanel.classList.add('show');
            progressBody.innerHTML = '';
            statusBadge.textContent = 'è¯„ä¼°ä¸­';
            progressText.textContent = `æ­£åœ¨è¿æ¥... (è¯„ä¼° ${maxChapters} ä¸ªç« èŠ‚)`;
            
            // æ·»åŠ è¿›åº¦é¡¹
            function addReviewerProgress(message, type = 'info') {
                const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                const item = document.createElement('div');
                item.className = `progress-item ${type}`;
                // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>ï¼Œä¿ç•™æ ¼å¼
                const formattedMessage = message.replace(/\n/g, '<br>');
                item.innerHTML = `
                    <div class="time">${time}</div>
                    <div class="message" style="white-space: pre-wrap;">${formattedMessage}</div>
                `;
                progressBody.appendChild(item);
                progressBody.scrollTop = progressBody.scrollHeight;
            }
            
            // å…³é—­ä¹‹å‰çš„è¿æ¥
            if (reviewerEventSource) {
                reviewerEventSource.close();
            }
            
            // åˆ›å»º SSE è¿æ¥ (ä¼ é€’ maxChapters å‚æ•°)
            const sseUrl = `/api/reviewer/tutorials/${tutorialId}/evaluate-stream?max_chapters=${maxChapters}`;
            reviewerEventSource = new EventSource(sseUrl);
            
            reviewerEventSource.addEventListener('connected', (e) => {
                const data = JSON.parse(e.data);
                addReviewerProgress('ğŸ”— è¿æ¥æˆåŠŸï¼Œå¼€å§‹è¯„ä¼°...', 'success');
                progressText.textContent = 'æ­£åœ¨å…‹éš†ä»“åº“...';
            });
            
            // å¤„ç†è¯¦ç»†æ—¥å¿—äº‹ä»¶
            reviewerEventSource.addEventListener('log', (e) => {
                const data = JSON.parse(e.data);
                const typeMap = { info: 'info', success: 'success', warning: 'warning', error: 'error' };
                addReviewerProgress(data.message, typeMap[data.level] || 'info');
            });
            
            reviewerEventSource.addEventListener('status', (e) => {
                const data = JSON.parse(e.data);
                const statusMap = {
                    'cloning': 'ğŸ“¥ æ­£åœ¨å…‹éš†ä»“åº“...',
                    'scanning': 'ğŸ” æ­£åœ¨æ‰«ææ–‡ä»¶...',
                    'evaluating': 'âš™ï¸ æ­£åœ¨è¯„ä¼°ç« èŠ‚...'
                };
                const msg = data.message || statusMap[data.status] || data.status;
                addReviewerProgress(msg, 'info');
                progressText.textContent = msg;
            });
            
            reviewerEventSource.addEventListener('clone_complete', (e) => {
                const data = JSON.parse(e.data);
                addReviewerProgress(`âœ… ä»“åº“å…‹éš†å®Œæˆ`, 'success');
            });
            
            reviewerEventSource.addEventListener('scan_complete', (e) => {
                const data = JSON.parse(e.data);
                addReviewerProgress(`ğŸ“„ æ‰«æå®Œæˆ: æ‰¾åˆ° ${data.total_files} ä¸ª Markdown æ–‡ä»¶`, 'success');
            });
            
            reviewerEventSource.addEventListener('chapters_ready', (e) => {
                const data = JSON.parse(e.data);
                addReviewerProgress(`ğŸ“š å‡†å¤‡è¯„ä¼° ${data.total} ä¸ªç« èŠ‚`, 'info');
            });
            
            reviewerEventSource.addEventListener('chapter_start', (e) => {
                const data = JSON.parse(e.data);
                progressText.textContent = `è¯„ä¼°ç« èŠ‚ ${data.chapter_index}/${data.total_chapters}`;
                addReviewerProgress(`ğŸ“– å¼€å§‹è¯„ä¼°: ${data.file_path}`, 'info');
            });
            
            reviewerEventSource.addEventListener('chapter_step', (e) => {
                const data = JSON.parse(e.data);
                const stepMap = {
                    'analyze': 'åˆ†æå†…å®¹',
                    'search': 'æœç´¢å‚è€ƒ',
                    'depth': 'æ·±åº¦æ£€æŸ¥',
                    'quality': 'è´¨é‡å®¡æ ¸',
                    'readability': 'å¯è¯»æ€§æ£€æµ‹',
                    'improve': 'ç”Ÿæˆå»ºè®®'
                };
                if (data.status === 'start') {
                    progressText.textContent = `${stepMap[data.step] || data.step}...`;
                }
            });
            
            reviewerEventSource.addEventListener('chapter_complete', (e) => {
                const data = JSON.parse(e.data);
                const scoreColor = data.overall_score >= 80 ? 'ğŸŸ¢' : data.overall_score >= 60 ? 'ğŸŸ¡' : 'ğŸ”´';
                
                // æ˜¾ç¤ºç« èŠ‚å®Œæˆä¿¡æ¯
                let msg = `${scoreColor} [${data.chapter_index}/${data.total_chapters}] ${data.title || data.file_path}`;
                msg += `\n   è¯„åˆ†: ${Math.round(data.overall_score)} (æ·±åº¦:${data.depth_score} è´¨é‡:${data.quality_score} å¯è¯»:${data.readability_score})`;
                msg += `\n   é—®é¢˜: ğŸ”´${data.high_issues} ğŸŸ¡${data.medium_issues} ğŸŸ¢${data.low_issues}`;
                
                // æ˜¾ç¤ºå‘ç°çš„é—®é¢˜
                if (data.issues && data.issues.length > 0) {
                    data.issues.forEach((issue, i) => {
                        const icon = issue.severity === 'high' ? 'ğŸ”´' : issue.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                        msg += `\n   ${icon} ${issue.description.substring(0, 60)}...`;
                    });
                }
                
                addReviewerProgress(msg, 'success');
                progressText.textContent = `å·²å®Œæˆ ${data.chapter_index}/${data.total_chapters} ç« èŠ‚`;
            });
            
            reviewerEventSource.addEventListener('chapter_error', (e) => {
                const data = JSON.parse(e.data);
                addReviewerProgress(`âŒ ç« èŠ‚è¯„ä¼°å¤±è´¥: ${data.error}`, 'error');
            });
            
            reviewerEventSource.addEventListener('evaluation_complete', (e) => {
                const data = JSON.parse(e.data);
                addReviewerProgress(`ğŸ‰ è¯„ä¼°å®Œæˆ! ç»¼åˆè¯„åˆ†: ${data.overall_score?.toFixed(1)}, é—®é¢˜: ${data.total_issues}, è€—æ—¶: ${data.duration_seconds}ç§’`, 'success');
            });
            
            reviewerEventSource.addEventListener('complete', (e) => {
                const data = JSON.parse(e.data);
                reviewerEventSource.close();
                reviewerEventSource = null;
                
                statusBadge.textContent = 'å®Œæˆ';
                progressText.textContent = 'è¯„ä¼°å®Œæˆ';
                
                const r = data.result;
                addReviewerProgress(`âœ¨ ç»¼åˆè¯„åˆ†: ${r.overall_score?.toFixed(1) || '-'} | ç« èŠ‚: ${r.evaluated_chapters}/${r.total_chapters} | é—®é¢˜: ${r.total_issues}`, 'success');
                
                // åˆ·æ–°æ•™ç¨‹åˆ—è¡¨
                loadTutorials();
            });
            
            reviewerEventSource.addEventListener('error', (e) => {
                let errorMsg = 'è¯„ä¼°å‡ºé”™';
                try {
                    const data = JSON.parse(e.data);
                    errorMsg = data.message || errorMsg;
                } catch {}
                
                addReviewerProgress(`âŒ ${errorMsg}`, 'error');
                statusBadge.textContent = 'å¤±è´¥';
                progressText.textContent = errorMsg;
                
                reviewerEventSource.close();
                reviewerEventSource = null;
            });
            
            reviewerEventSource.onerror = (e) => {
                if (reviewerEventSource.readyState === EventSource.CLOSED) {
                    return; // æ­£å¸¸å…³é—­
                }
                addReviewerProgress('âŒ è¿æ¥æ–­å¼€', 'error');
                statusBadge.textContent = 'æ–­å¼€';
                reviewerEventSource.close();
                reviewerEventSource = null;
            };
        }
        
        // å¯¼å‡ºæŠ¥å‘Šä¸º Markdown
        function exportReport(tutorialId) {
            window.open(`/api/reviewer/tutorials/${tutorialId}/export`, '_blank');
        }
        
        // æŸ¥çœ‹ç« èŠ‚åˆ—è¡¨
        async function viewChapters(tutorialId) {
            try {
                const response = await fetch(`/api/reviewer/tutorials/${tutorialId}/chapters`);
                const data = await response.json();
                if (data.success) {
                    showChaptersModal(tutorialId, data.chapters);
                }
            } catch (error) {
                console.error('è·å–ç« èŠ‚åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºç« èŠ‚åˆ—è¡¨å¼¹çª—
        function showChaptersModal(tutorialId, chapters) {
            const modal = document.createElement('div');
            modal.className = 'chapters-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const chaptersHtml = chapters.length > 0 ? chapters.map(c => `
                <div class="chapter-item" data-chapter-id="${c.id}" 
                    onclick="${c.total_issues > 0 ? `viewChapterIssues(${c.id})` : ''}"
                    style="
                    background: #f9f9f9; border-radius: 10px; padding: 12px 16px;
                    margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
                    cursor: ${c.total_issues > 0 ? 'pointer' : 'default'};
                    transition: all 0.2s;
                " ${c.total_issues > 0 ? 'onmouseover="this.style.background=\'#f0f0f0\'" onmouseout="this.style.background=\'#f9f9f9\'"' : ''}>
                    <div style="pointer-events: none;">
                        <div style="font-size: 14px; font-weight: 500; color: #333;">${c.title || c.file_name}</div>
                        <div style="font-size: 11px; color: #999;">${c.file_path}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; pointer-events: none;">
                        ${c.overall_score > 0 ? `
                            <div style="
                                width: 36px; height: 36px; border-radius: 50%;
                                background: ${c.overall_score >= 80 ? '#4ECDC4' : c.overall_score >= 60 ? '#FFD166' : '#ff6b6b'};
                                color: white; display: flex; align-items: center; justify-content: center;
                                font-size: 12px; font-weight: 600;
                            ">${c.overall_score}</div>
                        ` : '<span style="color: #999; font-size: 12px;">æœªè¯„ä¼°</span>'}
                        ${c.total_issues > 0 ? `<span style="font-size: 11px; color: #ff6b6b;">${c.total_issues} é—®é¢˜ â†’</span>` : ''}
                    </div>
                </div>
            `).join('') : '<div style="color: #999; text-align: center; padding: 40px;">æš‚æ— ç« èŠ‚æ•°æ®</div>';
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 16px; padding: 24px;
                    max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; font-size: 18px; color: #333;">ğŸ“š ç« èŠ‚åˆ—è¡¨ (${chapters.length})</h2>
                        <button onclick="this.closest('.chapters-modal').remove()" style="
                            background: none; border: none; font-size: 24px; cursor: pointer; color: #999;
                        ">Ã—</button>
                    </div>
                    <div>${chaptersHtml}</div>
                </div>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    return;
                }
                
                // ç‚¹å‡»ç« èŠ‚é¡¹æŸ¥çœ‹é—®é¢˜è¯¦æƒ…
                const chapterItem = e.target.closest('.chapter-item');
                if (chapterItem && chapterItem.dataset.chapterId) {
                    const chapterId = chapterItem.dataset.chapterId;
                    console.log('ç‚¹å‡»ç« èŠ‚:', chapterId);
                    viewChapterIssues(chapterId);
                }
            });
            
            document.body.appendChild(modal);
        }
        
        // æŸ¥çœ‹ç« èŠ‚é—®é¢˜è¯¦æƒ…
        async function viewChapterIssues(chapterId) {
            try {
                const response = await fetch(`/api/reviewer/chapters/${chapterId}/issues`);
                const data = await response.json();
                if (data.success) {
                    showIssuesModal(data.chapter, data.issues);
                } else {
                    alert('è·å–é—®é¢˜è¯¦æƒ…å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('è·å–é—®é¢˜è¯¦æƒ…å¤±è´¥:', error);
                alert('è·å–é—®é¢˜è¯¦æƒ…å¤±è´¥');
            }
        }
        
        // æ˜¾ç¤ºé—®é¢˜è¯¦æƒ…å¼¹çª—
        function showIssuesModal(chapter, issues) {
            const modal = document.createElement('div');
            modal.className = 'issues-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 1001;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const severityIcon = (s) => s === 'high' ? 'ğŸ”´' : s === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
            const categoryName = (c) => ({ depth: 'æ·±åº¦', quality: 'è´¨é‡', readability: 'å¯è¯»æ€§' }[c] || c);
            
            const issuesHtml = issues.length > 0 ? issues.map(issue => `
                <div style="
                    background: #f9f9f9; border-radius: 10px; padding: 14px 16px;
                    margin-bottom: 10px; border-left: 4px solid ${issue.severity === 'high' ? '#ff6b6b' : issue.severity === 'medium' ? '#FFD166' : '#4ECDC4'};
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: #666;">
                            ${severityIcon(issue.severity)} ${categoryName(issue.category)} Â· ${issue.issue_type}
                        </span>
                        <span style="font-size: 11px; color: #999;">${issue.location || ''}</span>
                    </div>
                    <div style="font-size: 13px; color: #333; margin-bottom: 8px;">${issue.description}</div>
                    ${issue.suggestion ? `
                        <div style="font-size: 12px; color: #4ECDC4; background: rgba(78,205,196,0.1); padding: 8px 10px; border-radius: 6px;">
                            ğŸ’¡ ${issue.suggestion}
                        </div>
                    ` : ''}
                    ${issue.reference ? `
                        <div style="font-size: 11px; color: #666; margin-top: 6px;">
                            ğŸ“š å‚è€ƒ: ${issue.reference}
                        </div>
                    ` : ''}
                </div>
            `).join('') : '<div style="color: #999; text-align: center; padding: 40px;">ğŸ‰ æ²¡æœ‰å‘ç°é—®é¢˜</div>';
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 16px; padding: 24px;
                    max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="margin: 0; font-size: 18px; color: #333;">ğŸ” é—®é¢˜è¯¦æƒ…</h2>
                        <button onclick="this.closest('.issues-modal').remove()" style="
                            background: none; border: none; font-size: 24px; cursor: pointer; color: #999;
                        ">Ã—</button>
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 15px; font-weight: 600;">${chapter.title || chapter.file_name}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">${chapter.file_path}</div>
                        <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 13px;">
                            <span>è¯„åˆ†: ${chapter.overall_score}</span>
                            <span>ğŸ”´ ${chapter.high_issues || 0}</span>
                            <span>ğŸŸ¡ ${chapter.medium_issues || 0}</span>
                            <span>ğŸŸ¢ ${chapter.low_issues || 0}</span>
                        </div>
                    </div>
                    <div>${issuesHtml}</div>
                </div>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }
        
        // åˆ é™¤æ•™ç¨‹
        async function deleteTutorial(tutorialId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ•™ç¨‹å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/reviewer/tutorials/${tutorialId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    loadTutorials();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤æ•™ç¨‹å¤±è´¥:', error);
            }
        }
        
        // reviewer é€‰é¡¹åˆ‡æ¢
        document.querySelectorAll('#reviewerOptions .option-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                if (tag.dataset.search !== undefined) {
                    document.querySelectorAll('#reviewerOptions .option-tag[data-search]').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>
